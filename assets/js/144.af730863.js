(window.webpackJsonp=window.webpackJsonp||[]).push([[144],{927:function(t,s,n){"use strict";n.r(s);var a=n(12),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("blockquote",[n("p",[t._v("最近研究k8s高可用部署时用到这个工具，随便做下笔记。")]),t._v(" "),n("p",[t._v("高可用：两台业务系统启动着相同的服务，如果有一台故障，另一台自动接管,我们将将这个称之为高可用。")])]),t._v(" "),n("h2",{attrs:{id:"为什么用它"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么用它"}},[t._v("#")]),t._v(" 为什么用它？")]),t._v(" "),n("p",[t._v("k8s需要lb+keepalived来保证高可用的api-server，具体是两台机器安装nginx、keepalived，nginx stream 代理3个master节点。keepalived一个 master 一个 backup 提供 vip。")]),t._v(" "),n("h2",{attrs:{id:"是什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#是什么"}},[t._v("#")]),t._v(" 是什么？")]),t._v(" "),n("p",[t._v("Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点。")]),t._v(" "),n("p",[t._v("后来Keepalived又加入了VRRP的功能，VRRP（Vritrual Router Redundancy Protocol,虚拟路由冗余协议)出现的目的是解决静态路由出现的单点故障问题，通过VRRP可以实现网络不间断稳定运行，因此Keepalvied 一方面具有服务器状态检测和故障隔离功能，另外一方面也有HA cluster功能，下面介绍一下VRRP协议实现的过程。")]),t._v(" "),n("h2",{attrs:{id:"配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),n("p",[n("code",[t._v("/etc/keepalived/keepalived.conf")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('global_defs {\n   notification_email {  #指定keepalived在发生切换时需要发送email到的对象，一行一个\n\t\tmonitor@3evip.cn\n   }\n   notification_email_from monitor@3evip.cn #指定发件人\n   smtp_server stmp.3evip.cn #指定smtp服务器地址\n   smtp_connect_timeout 30 #指定smtp连接超时时间\n   router_id LVS_DEVEL #运行keepalived机器的一个标识\n}\n\n# 这块基本用不到，没怎么学\nvrrp_sync_group VG_1{ #监控多个网段的实例\n\tgroup {\n\t\tinside_network #实例名\n\t\toutside_network\n\t}\n\tnotify_master /path/xx.sh #指定当切换到master时，执行的脚本\n\tnetify_backup /path/xx.sh #指定当切换到backup时，执行的脚本\n\tnotify_fault "path/xx.sh VG_1" #故障时执行的脚本\n\tnotify /path/xx.sh \n\tsmtp_alert #使用global_defs中提供的邮件地址和smtp服务器发送邮件通知\n}\n\nvrrp_instance inside_network {\n    state BACKUP #指定那个为master，那个为backup，如果设置了nopreempt这个值不起作用，主备考priority决定\n    interface eth0 #设置实例绑定的网卡，ifconfig 查看网卡\n    dont_track_primary #忽略vrrp的interface错误（默认不设置）\n    track_interface{ #设置额外的监控，里面那个网卡出现问题都会切换\n\t\teth0\n\t\teth1\n    }\n    mcast_src_ip #发送多播包的地址，如果不设置默认使用绑定网卡的primary ip\n    garp_master_delay #在切换到master状态后，延迟进行gratuitous ARP请求\n    virtual_router_id 50 #VPID标记，主备必须一样\n    priority 100 #优先级，高优先级竞选为master\n    advert_int 1 #检查间隔，默认1秒\n    nopreempt #设置为不抢占 注：这个配置只能设置在backup主机上，而且这个主机优先级要比另外一台高\n    preempt_delay #抢占延时，默认5分钟\n    debug #debug级别\n    authentication { #设置认证\n        auth_type PASS #认证方式\n        auth_pass 111111 #认证密码\n    }\n    virtual_ipaddress { #设置vip\n        192.168.36.200\n    }\n}\n\n# 这块也用不到\nvirtual_server 192.168.36.99 80 {\n    delay_loop 6 #健康检查时间间隔\n    lb_algo rr  #lvs调度算法rr|wrr|lc|wlc|lblc|sh|dh\n    lb_kind DR  #负载均衡转发规则NAT|DR|RUN\n    persistence_timeout 5 #会话保持时间\n    protocol TCP #使用的协议\n    persistence_granularity <NETMASK> #lvs会话保持粒度\n    virtualhost <string> #检查的web服务器的虚拟主机（host：头）    \n    sorry_server<IPADDR> <port> #备用机，所有realserver失效后启用\n\treal_server 192.168.200.5 23 {\n            weight 1 #默认为1,0为失效\n            inhibit_on_failure #在服务器健康检查失效时，将其设为0，而不是直接从ipvs中删除 \n            notify_up <string> | <quoted-string> #在检测到server up后执行脚本\n            notify_down <string> | <quoted-string> #在检测到server down后执行脚本\n\t\t\tTCP_CHECK {\n\t\t\t\tconnect_timeout 3 #连接超时时间\n\t\t\t\tnb_get_retry 3 #重连次数\n\t\t\t\tdelay_before_retry 3 #重连间隔时间\n\t\t\t\tconnect_port 23  健康检查的端口的端口\n\t\t\t\tbindto <ip>   \n\t\t\t}\n\t\t\tHTTP_GET | SSL_GET{\n\t\t\t\turl{ #检查url，可以指定多个\n\t\t\t\t\t\tpath /\n\t\t\t\t\t\tdigest <string> #检查后的摘要信息\n\t\t\t\t\t\tstatus_code 200 #检查的返回状态码\n\t\t\t\t}\n\t\t\t\tconnect_port <port> \n\t\t\t\tbindto <IPADD>\n\t\t\t\tconnect_timeout 5\n\t\t\t\tnb_get_retry 3\n\t\t\t\tdelay_before_retry 2\n\t\t\t}\n\n\t\t\tSMTP_CHECK{\n\t\t\t\t\thost{\n\t\t\t\t\t\tconnect_ip <IP ADDRESS>\n\t\t\t\t\t\tconnect_port <port> #默认检查25端口\n\t\t\t\t\t\tbindto <IP ADDRESS>\n\t\t\t\t\t}\n\t\t\t\t\tconnect_timeout 5\n\t\t\t\t\tretry 3\n\t\t\t\t\tdelay_before_retry 2\n\t\t\t\t\thelo_name <string> | <quoted-string> #smtp helo请求命令参数，可选\n\t\t\t}\n\t\t\tMISC_CHECK{\n\t\t\t\t\tmisc_path <string> | <quoted-string> #外部脚本路径\n\t\t\t\t\tmisc_timeout #脚本执行超时时间\n\t\t\t\t\tmisc_dynamic #如设置该项，则退出状态码会用来动态调整服务器的权重，返回0 正常，不修改；返回1，检查失败，权重改为0；返回2-255，正常，权重设置为：返回状态码-2\n\t\t\t}\n    }\n}\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br"),n("span",{staticClass:"line-number"},[t._v("50")]),n("br"),n("span",{staticClass:"line-number"},[t._v("51")]),n("br"),n("span",{staticClass:"line-number"},[t._v("52")]),n("br"),n("span",{staticClass:"line-number"},[t._v("53")]),n("br"),n("span",{staticClass:"line-number"},[t._v("54")]),n("br"),n("span",{staticClass:"line-number"},[t._v("55")]),n("br"),n("span",{staticClass:"line-number"},[t._v("56")]),n("br"),n("span",{staticClass:"line-number"},[t._v("57")]),n("br"),n("span",{staticClass:"line-number"},[t._v("58")]),n("br"),n("span",{staticClass:"line-number"},[t._v("59")]),n("br"),n("span",{staticClass:"line-number"},[t._v("60")]),n("br"),n("span",{staticClass:"line-number"},[t._v("61")]),n("br"),n("span",{staticClass:"line-number"},[t._v("62")]),n("br"),n("span",{staticClass:"line-number"},[t._v("63")]),n("br"),n("span",{staticClass:"line-number"},[t._v("64")]),n("br"),n("span",{staticClass:"line-number"},[t._v("65")]),n("br"),n("span",{staticClass:"line-number"},[t._v("66")]),n("br"),n("span",{staticClass:"line-number"},[t._v("67")]),n("br"),n("span",{staticClass:"line-number"},[t._v("68")]),n("br"),n("span",{staticClass:"line-number"},[t._v("69")]),n("br"),n("span",{staticClass:"line-number"},[t._v("70")]),n("br"),n("span",{staticClass:"line-number"},[t._v("71")]),n("br"),n("span",{staticClass:"line-number"},[t._v("72")]),n("br"),n("span",{staticClass:"line-number"},[t._v("73")]),n("br"),n("span",{staticClass:"line-number"},[t._v("74")]),n("br"),n("span",{staticClass:"line-number"},[t._v("75")]),n("br"),n("span",{staticClass:"line-number"},[t._v("76")]),n("br"),n("span",{staticClass:"line-number"},[t._v("77")]),n("br"),n("span",{staticClass:"line-number"},[t._v("78")]),n("br"),n("span",{staticClass:"line-number"},[t._v("79")]),n("br"),n("span",{staticClass:"line-number"},[t._v("80")]),n("br"),n("span",{staticClass:"line-number"},[t._v("81")]),n("br"),n("span",{staticClass:"line-number"},[t._v("82")]),n("br"),n("span",{staticClass:"line-number"},[t._v("83")]),n("br"),n("span",{staticClass:"line-number"},[t._v("84")]),n("br"),n("span",{staticClass:"line-number"},[t._v("85")]),n("br"),n("span",{staticClass:"line-number"},[t._v("86")]),n("br"),n("span",{staticClass:"line-number"},[t._v("87")]),n("br"),n("span",{staticClass:"line-number"},[t._v("88")]),n("br"),n("span",{staticClass:"line-number"},[t._v("89")]),n("br"),n("span",{staticClass:"line-number"},[t._v("90")]),n("br"),n("span",{staticClass:"line-number"},[t._v("91")]),n("br"),n("span",{staticClass:"line-number"},[t._v("92")]),n("br"),n("span",{staticClass:"line-number"},[t._v("93")]),n("br"),n("span",{staticClass:"line-number"},[t._v("94")]),n("br"),n("span",{staticClass:"line-number"},[t._v("95")]),n("br"),n("span",{staticClass:"line-number"},[t._v("96")]),n("br"),n("span",{staticClass:"line-number"},[t._v("97")]),n("br"),n("span",{staticClass:"line-number"},[t._v("98")]),n("br"),n("span",{staticClass:"line-number"},[t._v("99")]),n("br"),n("span",{staticClass:"line-number"},[t._v("100")]),n("br"),n("span",{staticClass:"line-number"},[t._v("101")]),n("br")])]),n("h2",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[t._v("#")]),t._v(" 测试")]),t._v(" "),n("p",[t._v("两台机器一台 master 一台 backup，"),n("code",[t._v("tail -f /var/log/messages")]),t._v(", 关掉其中一台的keepalived，查看 "),n("code",[t._v("ip addr")]),t._v("，vip 是否切换。")])])}),[],!1,null,null,null);s.default=e.exports}}]);