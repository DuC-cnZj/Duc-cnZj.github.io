(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{583:function(a,s,t){a.exports=t.p+"assets/img/2018_11_06_MYt3SOmiz1.b87633c6.png"},584:function(a,s,t){a.exports=t.p+"assets/img/2018_11_06_HBcg9En2J1.8cbf770a.png"},585:function(a,s,t){a.exports=t.p+"assets/img/2018_11_06_R2imWobt9i.784da2b9.png"},586:function(a,s,t){a.exports=t.p+"assets/img/2018_11_09_DqA5USR7mK.d70441a0.png"},834:function(a,s,t){"use strict";t.r(s);var e=t(12),r=Object(e.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h2",{attrs:{id:"起因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#起因"}},[a._v("#")]),a._v(" 起因")]),a._v(" "),e("blockquote",[e("p",[a._v("因为博客是运行在docker上的，docker volume 总感觉不安全，而且博客项目的文章多了，如果不及时备份，则会丢失数据。")])]),a._v(" "),e("h2",{attrs:{id:"经过"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#经过"}},[a._v("#")]),a._v(" 经过")]),a._v(" "),e("h4",{attrs:{id:"step1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#step1"}},[a._v("#")]),a._v(" "),e("strong",[a._v("step1")])]),a._v(" "),e("p",[a._v("因为博客后台是 lumen ，相关的扩展包没有 laravel 那么多，所以处理起来还是比较麻烦的。")]),a._v(" "),e("p",[a._v("之前 star 了一个扩展包 "),e("a",{attrs:{href:"https://github.com/spatie/laravel-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("spatie/laravel-backup"),e("OutboundLink")],1),a._v("，它有2800+ ⭐，本以为用这个包就能很愉快的解决备份问题，但是。。。👉")]),a._v(" "),e("p",[e("img",{attrs:{src:t(583),alt:"2018_11_06_MYt3SOmiz1.png"}})]),a._v(" "),e("p",[a._v("好吧！！！作者都说不支持了，那就是没戏了。")]),a._v(" "),e("p",[a._v("那就再找找吧！")]),a._v(" "),e("br"),a._v(" "),e("h4",{attrs:{id:"step2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#step2"}},[a._v("#")]),a._v(" step2")]),a._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/backup-manager/laravel",target:"_blank",rel:"noopener noreferrer"}},[a._v("backup-manager/laravel"),e("OutboundLink")],1),a._v(" chrome 搜来搜去又找到了这个包，才 500+ 多个 star，不管了先试试把")]),a._v(" "),e("ol",[e("li",[a._v("首先安装 "),e("code",[a._v("composer require backup-manager/laravel")])]),a._v(" "),e("li",[a._v("配置，我用的是 lumen 5.7.*")])]),a._v(" "),e("div",{staticClass:"language-php line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-php"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// FOR LUMEN 5.5 AND ABOVE")]),a._v("\napp"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("configure")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[a._v("'backup-manager'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" \napp"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("register")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name class-name-fully-qualified static-context"}},[a._v("BackupManager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("Laravel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("Lumen55ServiceProvider")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("::")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[a._v("配置完后就是使用了\n"),e("img",{attrs:{src:t(584),alt:"2018_11_06_HBcg9En2J1.png"}})]),a._v(" "),e("li",[a._v("它自带了三个命令")])]),a._v(" "),e("ul",[e("li",[e("code",[a._v("db:backup")]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("php artisan db:backup --database"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql --destination"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("dropbox --destinationPath"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("project --timestamp"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"d-m-Y"')]),a._v(" --compression"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("gzip\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])])]),a._v(" "),e("li",[e("code",[a._v("db:list")]),a._v("  查看命令帮助即可")]),a._v(" "),e("li",[e("code",[a._v("db:restore")]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("php artisan db:restore --database"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql --compression"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("gzip --source"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("local --sourcePath"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/backups/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$lastDumpFile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])])])]),a._v(" "),e("h2",{attrs:{id:"以为这样就轻松解决了吗"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#以为这样就轻松解决了吗"}},[a._v("#")]),a._v(" 以为这样就轻松解决了吗？？？")]),a._v(" "),e("blockquote",[e("p",[a._v("如果不是docker驱动的，那是真的就这样解决了")])]),a._v(" "),e("p",[a._v("因为我是docker驱动，那么问题出现了：")]),a._v(" "),e("ol",[e("li",[a._v("作为docker驱动的app，在我的app images中是没有 "),e("code",[a._v("mysqldump")]),a._v(" 这个命令的，但是如果我 "),e("code",[a._v("apt install mysql-client-5.7")]),a._v(" 再打包制作镜像，这就不太好，毕竟我好几个app都用这个image")]),a._v(" "),e("li",[a._v("那么如何在不修改image镜像的情况下，让它运行起来呢？？")])]),a._v(" "),e("h2",{attrs:{id:"我的解决方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#我的解决方案"}},[a._v("#")]),a._v(" 我的解决方案")]),a._v(" "),e("ol",[e("li",[a._v("当然是加脚本咯"),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/usr/bin/env bash ")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# init.sh")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" -f /usr/bin/mysqldump "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mysqldump exists"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("||")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("apt update "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" -y mysql-client-5.7"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])])]),a._v(" "),e("li",[a._v("在我的image中允许添加用户脚本，只需要在环境变量中加入 "),e("code",[a._v("BASH_NAMES:init.sh")])]),a._v(" "),e("li",[a._v("done!这样加好之后，docker-compose 启动的时候就会在不修改镜像的情况下自动安装mysql客户端")]),a._v(" "),e("li",[a._v("但是问题又出现了！？？⚠ 当容器 "),e("code",[a._v("down")]),a._v(" 之后再次启动就会重新下载mysql客户端，这个问题用脚指头想想就知道了，没有持久化数据，即需要用voulmes存储修改的内容")])]),a._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[a._v("installdata"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/usr/bin "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 嗯在vlume中加这一句")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h2",{attrs:{id:"将数据库备份加到定时任务中去"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#将数据库备份加到定时任务中去"}},[a._v("#")]),a._v(" 将数据库备份加到定时任务中去")]),a._v(" "),e("p",[e("img",{attrs:{src:t(585),alt:"2018_11_06_R2imWobt9i.png"}})]),a._v(" "),e("h2",{attrs:{id:"备份结果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#备份结果"}},[a._v("#")]),a._v(" 备份结果")]),a._v(" "),e("p",[e("img",{attrs:{src:t(586),alt:"2018_11_09_DqA5USR7mK.png"}})]),a._v(" "),e("blockquote",[e("p",[a._v("我知道你们看不懂，我懂就行了，哈哈哈哈哈哈哈哈哈")])]),a._v(" "),e("p",[a._v("🧀 👏")])])}),[],!1,null,null,null);s.default=r.exports}}]);