(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{550:function(s,t,a){s.exports=a.p+"assets/img/2018_12_28_VLlhjOGkk7.eb806507.png"},551:function(s,t,a){s.exports=a.p+"assets/img/2018_12_28_NSLYBg5uJu.58cc2a09.png"},552:function(s,t,a){s.exports=a.p+"assets/img/2018_12_28_M2ObJ8gZm6.dd1c04e4.png"},553:function(s,t,a){s.exports=a.p+"assets/img/2018_12_28_5AEYZVgsFl.574e906c.png"},787:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"先搭建gitlab"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#先搭建gitlab"}},[s._v("#")]),s._v(" 先搭建gitlab")]),s._v(" "),n("blockquote",[n("p",[s._v("本文使用docker安装gitlab https://docs.gitlab.com/omnibus/docker/")])]),s._v(" "),n("p",[s._v("运行该命令可在本地安装gitlab")]),s._v(" "),n("blockquote",[n("p",[s._v("注意 gitlab.example.com 需要在 /ets/hosts 里面配置")])]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# first step")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" gitlab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" gitlab\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# second")]),s._v("\ndocker run --detach "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --hostname gitlab.example.com "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --publish "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":443 --publish "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 --publish "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":22 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --name gitlab "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --volume "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/config:/etc/gitlab "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --volume "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/logs:/var/log/gitlab "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --volume "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/data:/var/opt/gitlab "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    gitlab/gitlab-ce:latest    \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("上面的命令完成后，你会在 "),n("code",[s._v("gitlab")]),s._v(" 目录下看到 "),n("code",[s._v("config")]),s._v(" "),n("code",[s._v("logs")]),s._v(" "),n("code",[s._v("data")]),s._v(" 三个目录，分别存着配置日志和数据文件")]),s._v(" "),n("h3",{attrs:{id:"tips"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tips"}},[s._v("#")]),s._v(" tips")]),s._v(" "),n("blockquote",[n("p",[s._v("由于服务启动比较慢，所以如果出现 502 请耐心等几分钟")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(550),alt:"2018_12_28_VLlhjOGkk7.png"}})]),s._v(" "),n("p",[s._v("等待片刻后，输入密码")]),s._v(" "),n("p",[n("img",{attrs:{src:a(551),alt:"2018_12_28_NSLYBg5uJu.png"}}),s._v("\n注册一个账号")]),s._v(" "),n("p",[n("img",{attrs:{src:a(552),alt:"2018_12_28_M2ObJ8gZm6.png"}}),s._v("\n蛋疼的服务器 不玩了cao")]),s._v(" "),n("h3",{attrs:{id:"docker-compose-yaml-参考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yaml-参考"}},[s._v("#")]),s._v(" docker-compose.yaml 参考")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gitlab-runnner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("runner\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" gitlabnet\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./runner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("runner\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /var/run/docker.sock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/run/docker.sock\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gitlab")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ce"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab.example.com'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" gitlabnet\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/gitlab\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./logs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/log/gitlab\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/opt/gitlab\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token datetime number"}},[s._v("80:80")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 443"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"22:22"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gitlabnet")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("driver")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bridge\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("h2",{attrs:{id:"使用docker搭建runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用docker搭建runner"}},[s._v("#")]),s._v(" 使用docker搭建runner")]),s._v(" "),n("h4",{attrs:{id:"方法一"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方法一"}},[s._v("#")]),s._v(" 方法一")]),s._v(" "),n("p",[s._v("直接写在 "),n("code",[s._v("docker-compose.yaml")]),s._v(" 里面 这里你必须 "),n("code",[s._v("docker-in-docker")]),s._v("  ，使用这条命令")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("docker run -v /var/run/docker.sock:/var/run/docker.sock "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("否则在你的docker容器中无法使用docker。")]),s._v(" "),n("p",[s._v("不过DinD这种方式好像不太好，具体google。")]),s._v(" "),n("h4",{attrs:{id:"方法二"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方法二"}},[s._v("#")]),s._v(" 方法二")]),s._v(" "),n("p",[s._v("开一台虚拟机，然后当做一台新的服务器来安装docker以及gitlab-runner")]),s._v(" "),n("h3",{attrs:{id:"添加-runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加-runner"}},[s._v("#")]),s._v(" 添加 runner")]),s._v(" "),n("p",[s._v("方法一")]),s._v(" "),n("p",[s._v("执行，注册，url 和 token 在项目 setting-> CI/CD  里面有，每个项目都不一样")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("gitlab-runner register \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("方法二")]),s._v(" "),n("p",[s._v("直接修改配置文件  config.toml")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# runner-config/config.toml")]),s._v("\nconcurrent = 1\ncheck_interval = 0\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("session_server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  session_timeout = 1800\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n  name = "a"\n  url = "http'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//gitlab.example.com/"\n  token = "fFEGL5JzN9vPKTiyx4s7"\n  executor = "docker"\n  '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    tls_verify = false\n    image = "php'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('7.1"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    dns = '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.99.100"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重点！！！，不然你的ci用的docker将无法拉取代码，会connection refused")]),s._v("\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cache"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    shm_size = 0\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.gcs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n  name = "b"\n  url = "http'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//gitlab.example.com/"\n  token = "3Seirt'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('EwZ6RybwaL1wf"\n  executor = "docker"\n  '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    tls_verify = false\n    dns = "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.99.100"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    image = "php'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('7.2"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cache"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    shm_size = 0\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.gcs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n  name = "ci"\n  url = "http'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//gitlab.example.com/"\n  token = "aMMMxCvrYNA'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('E4KfS1Ru"\n  executor = "docker"\n  '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    tls_verify = false\n    image = "php'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('7.1"\n    dns = '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.99.100"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cache"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    shm_size = 0\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.gcs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n  name = "ci"\n  url = "http'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//gitlab.example.com/"\n  token = "n8oB_P2cXeUPwjpLw3n2"\n  executor = "docker"\n  '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    tls_verify = false\n    dns = "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.99.100"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    image = "php'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('7.2"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cache"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    shm_size = 0\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.gcs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br")])]),n("h2",{attrs:{id:"解决本地搭建docker-ci-runner-dns-服务问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决本地搭建docker-ci-runner-dns-服务问题"}},[s._v("#")]),s._v(" 解决本地搭建docker ci runner DNS 服务问题")]),s._v(" "),n("blockquote",[n("p",[s._v("此举主要是为了解决本地搭建的gitlab")]),s._v(" "),n("p",[s._v("-ci runner 中的docker 容器无法解析到本地的 gitlab.example.com")])]),s._v(" "),n("ol",[n("li",[s._v("新开一台linux（我选用docker-machine），安装docker")]),s._v(" "),n("li",[n("code",[s._v("docker run -d -p 53:53/tcp -p 53:53/udp --cap-add=NET_ADMIN --name dns-server andyshinn/dnsmasp")])]),s._v(" "),n("li",[n("code",[s._v("docker exec -it dns-server /bin/sh")])]),s._v(" "),n("li",[s._v("vi /etc/resolv.dnsmasq "),n("code",[s._v("nameserver 114.114.114.114 nameserver 8.8.8.8")])]),s._v(" "),n("li",[s._v("vi /etc/dnsmasqhosts 加入 "),n("code",[s._v("192.168.200.190 gitlab.example.com")])]),s._v(" "),n("li",[s._v("修改 dnsmasq,  vim /etc/dnsmasq.conf  "),n("code",[s._v("resolv-file=/etc/resolv.dnsmasq addn-hosts=/etc/dnsmasqhosts")])]),s._v(" "),n("li",[s._v("回到宿主机重启dns服务 "),n("code",[s._v("docker restart dns-server")])]),s._v(" "),n("li",[s._v("这时候dokcer host 就是一台dns服务器了加入他的地址是 192.168.99.100")])]),s._v(" "),n("blockquote",[n("p",[s._v("❗️❗️❗️❗️❗️")]),s._v(" "),n("p",[s._v("注意这里如果你安照上面那样做了，你做到的只是gitlab-runner 能 ping 通 gitlab.example.com 但是，你gitlab-runner 中的docker容器里面还是没办法ping通的")]),s._v(" "),n("p",[s._v("所以你要在 config.toml 中加入 dns 配置项 "),n("code",[s._v('dns = ["192.168.99.100"]')]),s._v("  磕了我两天，wocao")])]),s._v(" "),n("h2",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),n("p",[s._v("在gitlab ci 上修改 /etc/resolv.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("nameserver 192.168.99.100\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("就可以直接ping通gitlab.example.com 了")]),s._v(" "),n("h2",{attrs:{id:"gitlab-ci-yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-yml"}},[s._v("#")]),s._v(" .gitlab-ci.yml")]),s._v(" "),n("h3",{attrs:{id:"一级变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一级变量"}},[s._v("#")]),s._v(" 一级变量")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("关键字")]),s._v(" "),n("th",[s._v("是否必须")]),s._v(" "),n("th",[s._v("描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("image")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("用于docker镜像，查看"),n("a",{attrs:{href:"https://docs.gitlab.com/ce/ci/docker/README.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker"),n("OutboundLink")],1),s._v("文档")])]),s._v(" "),n("tr",[n("td",[s._v("services")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("用于docker服务，查看"),n("a",{attrs:{href:"https://docs.gitlab.com/ce/ci/docker/README.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker"),n("OutboundLink")],1),s._v("文档")])]),s._v(" "),n("tr",[n("td",[s._v("stages")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("定义构建阶段")])]),s._v(" "),n("tr",[n("td",[s._v("types")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[n("code",[s._v("stages")]),s._v(" 的别名(已废除)")])]),s._v(" "),n("tr",[n("td",[s._v("before_script")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("定义在每个job之前运行的命令")])]),s._v(" "),n("tr",[n("td",[s._v("after_script")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("定义在每个job之后运行的命令")])]),s._v(" "),n("tr",[n("td",[s._v("variables")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("定义构建变量")])]),s._v(" "),n("tr",[n("td",[s._v("cache")]),s._v(" "),n("td",[s._v("否")]),s._v(" "),n("td",[s._v("定义一组文件列表，可在后续运行中使用")])])])]),s._v(" "),n("h3",{attrs:{id:"jobs-中的变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jobs-中的变量"}},[s._v("#")]),s._v(" Jobs 中的变量")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Keyword")]),s._v(" "),n("th",[s._v("Required")]),s._v(" "),n("th",[s._v("Description")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("script")]),s._v(" "),n("td",[s._v("yes")]),s._v(" "),n("td",[s._v("Runner执行的命令或脚本")])]),s._v(" "),n("tr",[n("td",[s._v("image")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("所使用的docker镜像，查阅"),n("a",{attrs:{href:"https://docs.gitlab.com/ce/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用docker镜像"),n("OutboundLink")],1)])]),s._v(" "),n("tr",[n("td",[s._v("services")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("所使用的docker服务，查阅"),n("a",{attrs:{href:"https://docs.gitlab.com/ce/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用docker镜像"),n("OutboundLink")],1)])]),s._v(" "),n("tr",[n("td",[s._v("stage")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义job stage（默认："),n("code",[s._v("test")]),s._v("）")])]),s._v(" "),n("tr",[n("td",[s._v("type")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[n("code",[s._v("stage")]),s._v("的别名（已弃用）")])]),s._v(" "),n("tr",[n("td",[s._v("variables")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义job级别的变量")])]),s._v(" "),n("tr",[n("td",[s._v("only")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义一列git分支，并为其创建job")])]),s._v(" "),n("tr",[n("td",[s._v("except")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义一列git分支，不创建job")])]),s._v(" "),n("tr",[n("td",[s._v("tags")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义一列tags，用来指定选择哪个Runner（同时Runner也要设置tags）")])]),s._v(" "),n("tr",[n("td",[s._v("allow_failure")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("允许job失败。失败的job不影响commit状态")])]),s._v(" "),n("tr",[n("td",[s._v("when")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义何时开始job。可以是"),n("code",[s._v("on_success")]),s._v("，"),n("code",[s._v("on_failure")]),s._v("，"),n("code",[s._v("always")]),s._v("或者"),n("code",[s._v("manual")])])]),s._v(" "),n("tr",[n("td",[s._v("dependencies")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义job依赖关系，这样他们就可以互相传递artifacts")])]),s._v(" "),n("tr",[n("td",[s._v("cache")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义应在后续运行之间缓存的文件列表")])]),s._v(" "),n("tr",[n("td",[s._v("before_script")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("重写一组在作业前执行的命令")])]),s._v(" "),n("tr",[n("td",[s._v("after_script")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("重写一组在作业后执行的命令")])]),s._v(" "),n("tr",[n("td",[s._v("environment")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义此作业完成部署的环境名称")])]),s._v(" "),n("tr",[n("td",[s._v("coverage")]),s._v(" "),n("td",[s._v("no")]),s._v(" "),n("td",[s._v("定义给定作业的代码覆盖率设置")])])])]),s._v(" "),n("h2",{attrs:{id:"在-laravel-中-cicd"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在-laravel-中-cicd"}},[s._v("#")]),s._v(" 在 laravel 中 cicd")]),s._v(" "),n("blockquote",[n("p",[s._v("完整版请参考 https://github.com/ohdearapp/gitlab-ci-pipeline-for-laravel")])]),s._v(" "),n("p",[s._v("简单案例参考")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" preparation\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" testing\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" deploy\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("REDIS_PORT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("composer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" preparation\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" edbizarro/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pipeline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.2")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" duc72\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" php "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" composer install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prefer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dist "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ansi "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("interaction "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("progress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scripts\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("artifacts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" vendor/\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" .env\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expire_in")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1 days\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("when")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" vendor/\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("phpunit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" testing\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" edbizarro/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pipeline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.2")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" duc72\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dependencies")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" composer\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" php "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./vendor/phpunit/phpunit/phpunit "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("version\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" php "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("d short_open_tag=off ./vendor/phpunit/phpunit/phpunit "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("colors=never "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stderr\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("artifacts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./storage/logs "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for debugging")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expire_in")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1 days\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("when")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on_failure\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker build "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("t duc/app .\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker rm duc/app "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker run "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p 8080"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("80 duc/app\n   "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" on_shell\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br")])]),n("h2",{attrs:{id:"测试中遇到的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试中遇到的问题"}},[s._v("#")]),s._v(" 测试中遇到的问题")]),s._v(" "),n("p",[s._v("如果你的测试中使用了 redis 那么可能会出现")]),s._v(" "),n("p",[s._v("问题原因 https://github.com/laravel/framework/issues/7904")]),s._v(" "),n("blockquote",[n("p",[s._v("在我的情况下，问题是OS环境变量REDIS_PORT被设置为")]),s._v(" "),n("p",[n("code",[s._v("REDIS_PORT=tcp://172.17.0.4:6379")]),s._v("\n并覆盖Laravel .env文件中设置的REDIS_PORT。")]),s._v(" "),n("p",[s._v("也许Artisan获得OS环境变量。我解决了它将OS环境变量REDIS_PORT设置为")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[s._v("REDIS_PORT=6379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("我使用docker和docker-compose，所以我只修改了我的docker-compose.yml，添加了这两行：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[s._v("   "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("REDIS_PORT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Connection refused [tcp://redis:tcp://172.17.0.3:6379]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("解决：在 .gitlab-ci.yaml 中加入环境变量")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("REDIS_PORT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"最后"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[s._v("#")]),s._v(" 最后")]),s._v(" "),n("p",[s._v("本文只是简单实现，更多配置，更多参数，请去研究官方文档！")]),s._v(" "),n("blockquote",[n("p",[s._v("在无数次删除容器，修改配置，提交代码测试中，通过了测试😭")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(553),alt:"2018_12_28_5AEYZVgsFl.png"}}),s._v("\n这些只是简单的实现了ci/cd ，也为我之后学习 kubernetes 打下基础😄")])])}),[],!1,null,null,null);t.default=e.exports}}]);