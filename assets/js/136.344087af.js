(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{930:function(s,t,a){"use strict";a.r(t);var n=a(13),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("以下两篇文章都讲的很到位，建议细品")])]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://zhaohuabing.com/post/2020-03-19-pki/",target:"_blank",rel:"noopener noreferrer"}},[s._v("数字证书原理-赵化冰的博客 | Zhaohuabing Blog"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://zhaohuabing.com/post/2020-05-19-k8s-certificate/",target:"_blank",rel:"noopener noreferrer"}},[s._v("一文带你彻底厘清 Kubernetes 中的证书工作机制-赵化冰的博客 | Zhaohuabing Blog"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("CN 字段，对于 SSL 证书，一般为网站域名；而对于代码签名证书则为申请单位名称；而对于客户端证书则为证书申请者的姓名；")]),s._v(" "),a("p",[s._v("简称：O 字段，对于 SSL 证书，一般为网站域名；而对于代码签名证书则为申请单位名称；而对于客户端单位证书则为证书申请者所在单位名称；")]),s._v(" "),a("p",[s._v("所在城市 (Locality)| 简称：L 字段\n所在省份 (State/Provice)| 简称：ST 字段\n所在国家 (Country)| 简称：C 字段，只能是国家字母缩写，如中国：CN")]),s._v(" "),a("h2",{attrs:{id:"证书中的-hosts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#证书中的-hosts"}},[s._v("#")]),s._v(" 证书中的 hosts")]),s._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/185",target:"_blank",rel:"noopener noreferrer"}},[s._v("kube-apiserver 证书中的 hosts 受限问题 · Issue #185 · opsnull/follow-me-install-kubernetes-cluster · GitHub"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("我简单的把证书分为三类：")]),s._v(" "),a("ul",[a("li",[s._v("server 证书：server auth；")]),s._v(" "),a("li",[s._v("client 证书：client auth；")]),s._v(" "),a("li",[s._v("peer 证书：server auth + client auth。")])]),s._v(" "),a("p",[s._v("经过我的实践和理解：client 证书可以不用指定 "),a("code",[s._v("hosts")]),s._v(" 字段，server 证书和 peer 证书必须要指定 "),a("code",[s._v("hosts")]),s._v(" 字段，否则客户端访问时会提示错误：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Unable to connect to the server: x509: cannot validate certificate for 192.168.1.x because it doesn't contain any IP SANs\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("确实有这个问题，用 go 试了下，hosts 必须包含服务的地址不然就会出问题")]),s._v(" "),a("p",[s._v("但是当我在做 HA master （我使用 Keepalived 新增了一个 VIP，并且使用 HAProxy 代理 https 的 kube-apiserver）时，就会存在一个问题：由于 VIP 并不在 kube-apiserver 的 "),a("code",[s._v("hosts")]),s._v(" 中，导致所有客户端都没有办法通过 VIP 来访问 kube-apiserver （提示 VIP 不在 SANS 中）。")]),s._v(" "),a("h2",{attrs:{id:"golang-自签证书实现-https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#golang-自签证书实现-https"}},[s._v("#")]),s._v(" golang 自签证书实现 https")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://toscode.gitee.com/huy_admin/Go-HTTPS-Demo",target:"_blank",rel:"noopener noreferrer"}},[s._v("Go HTTPS Demo: golang 生成https 自签名证书，及服务端、客户端双向认证代码"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"k8s-集群-group-和-用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s-集群-group-和-用户"}},[s._v("#")]),s._v(" k8s 集群 Group 和 用户")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("准备集群绑定 yaml")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRoleBinding\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" custom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reader\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subjects")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Group\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" reader\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roleRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRole\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" view\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("准备证书所需的配置文件")]),s._v(" "),a("div",{staticClass:"language-toml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("req")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("default_bits")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("prompt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" no\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("default_md")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" sha256\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("req_extensions")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" req_ext\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("distinguished_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" dn\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("dn")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("C")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" CN\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("ST")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" ZJ\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("L")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" HangZhou\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CN 是集群中的 user")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("CN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" duc\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# O：事先在集群创建了 Group, 用户使用事先创建好的群组就会有这个群组的权限")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 总之这个是和 Group 关联的")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("O")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" reader\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("req_ext")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("subjectAltName")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" @alt_names\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("alt_names")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("IP.1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token table class-name"}},[s._v("v3_ext")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("authorityKeyIdentifier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("keyid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("issuer:always\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("basicConstraints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("CA:FALSE\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("keyUsage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("keyEncipherment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("dataEncipherment\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("extendedKeyUsage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("serverAuth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("clientAuth\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[s._v("subjectAltName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("@alt_names\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("先创建一个用户")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("openssl genrsa -out duc.key "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n\nopenssl req -new -key duc.key -out duc.csr -config cfg\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ca 证书需要自己拷贝出来")]),s._v("\nopenssl x509 -req -in duc.csr -CA pki/ca.crt -CAkey pki/ca.key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-CAcreateserial -out duc.crt -days "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-extensions v3_ext -extfile cfg\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("设置用户")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kc config set-credentials duc --client-certificate duc.crt --client-key duc.key\nkc config set-context duc --cluster docker-desktop --user duc\nkc config use-context duc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("测试")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kc auth can-i edit po\nkc auth can-i get deploy\nkc auth can-i create ns\nkc auth can-i get ns\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);