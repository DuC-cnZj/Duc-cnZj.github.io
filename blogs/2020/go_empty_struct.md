---
title: ä¸€ä¸ªç©º struct çš„â€œå‘â€(å˜é‡é€ƒé€¸)
date: '2020-06-07 17:52:22'
sidebar: false
categories:
 - æŠ€æœ¯
tags:
 - golang
publish: true
---

> è½¬è‡ª https://xargin.com/addr-of-empty-struct-may-not-eq/



https://www.zhihu.com/question/364687707

åœ¨çŸ¥ä¹ä¸Šå·²ç»è¯´äº†åŸå› ï¼Œä¸è¿‡åªæ˜¯è®²å®˜æ–¹çš„ specï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ç°ä¸Šå…·ä½“ä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·çš„ã€‚

```
package main

import "fmt"

func main() {
	a := new(struct{})
	b := new(struct{})
	println(a, b, a == b)

	c := new(struct{})
	d := new(struct{})
	fmt.Println(c, d, c == d)
}
```

ç»“æœå¯èƒ½è®©ä½ å¾ˆæƒŠè®¶ï¼š

```
0xc00007af1f 0xc00007af1f false
&{} &{} true
```

å¦‚æœä¹‹å‰ç¢°åˆ°è¿‡ç»™ç¨‹åºåŠ ä¸Š fmt.Println å°±å¯¼è‡´ç»“æœå˜åŒ–çš„æƒ…å†µçš„åŒå­¦ï¼Œå¯èƒ½ä¼šæƒ³åˆ°è¿™é‡Œçš„åŸå› ï¼Œæ˜¯å’Œé€ƒé€¸åˆ†æç›¸å…³ã€‚(å¯ä»¥å‚è€ƒè¿™ä¸¤ä¸ª issue ï¼š[8618](https://github.com/golang/go/issues/8618) å’Œ [31317](https://github.com/golang/go/issues/31317))

æ²¡é”™ï¼š

```
~/test git:master â¯â¯â¯ cat -n true.go                                                                              âœ± â—¼
     1	package main
     2
     3	import "fmt"
     4
     5	func main() {
     6		a := new(struct{})
     7		b := new(struct{})
     8		println(a, b, a == b)
     9
    10		c := new(struct{})
    11		d := new(struct{})
    12		fmt.Println(c, d, c == d)
    13	}
~/test git:master â¯â¯â¯ go run -gcflags="-m" true.go                           

# command-line-arguments
./true.go:12:13: inlining call to fmt.Println
./true.go:6:10: main new(struct {}) does not escape
./true.go:7:10: main new(struct {}) does not escape
./true.go:10:10: new(struct {}) escapes to heap
./true.go:11:10: new(struct {}) escapes to heap
./true.go:12:13: c escapes to heap
./true.go:12:13: d escapes to heap
./true.go:12:22: c == d escapes to heap
./true.go:12:13: main []interface {} literal does not escape
./true.go:12:13: io.Writer(os.Stdout) escapes to heap
<autogenerated>:1: (*File).close .this does not escape
0xc00007af1f 0xc00007af1f false
&{} &{} true
```

åœ¨ fmt.Println ä¸­å•ç‹¬å‡ºç°äº† cï¼Œæ‰€ä»¥ c = new çš„æ—¶å€™å°±å‘ç”Ÿäº†é€ƒé€¸ï¼Œd ä¹ŸåŒç†ï¼š

- æœªé€ƒé€¸ï¼šaï¼Œb
- é€ƒé€¸ï¼šcï¼Œd

çœ‹è¿‡ä¸€ç‚¹ go runtime ä»£ç çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œåœ¨ runtime é‡Œæœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼š

```
// base address for all 0-byte allocations
var zerobase uintptr
```

0 å¤§å°çš„å†…å­˜åˆ†é…å‡ä¼šæŒ‡å‘è¯¥å˜é‡åœ°å€ï¼Œæ‰€è°“çš„ 0 å­—èŠ‚ï¼Œä¸»è¦å°±æ˜¯è¿™ç§ç©º structã€‚ä¸è¿‡è¿™é‡Œæ²¡è¯´æ¸…æ¥šçš„æ˜¯ï¼Œåªæœ‰åœ¨**å †ä¸Š**åˆ†é…çš„ 0 å¤§å°çš„ struct æ‰ä¼šæŒ‡å‘è¯¥åœ°å€ï¼š

```
package main

import "fmt"

var a = new(struct{}) // å †ä¸Š

func main() {
	var b = new(struct{})
	fmt.Println(b/*è¿™é‡Œå•ç‹¬æ‰“å°äº†ï¼Œæ‰€ä»¥ b escape åˆ°å †ä¸Š*/, a == b)
}
```

é‚£ä¹ˆç©º struct é€ƒé€¸ä¹‹åå…¶å®éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œåœ°å€ç›¸ç­‰ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç†è§£äº†ã€‚

æ²¡é€ƒé€¸çš„ a å’Œ b ä¸ºä»€ä¹ˆåœ°å€ä¸ç›¸ç­‰å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥ç¥­å‡º SSA å¤§æ³•ï¼š

```
~/test git:master â¯â¯â¯ sudo GOSSAFUNC=main go build true.go
```

![2020_06_07_LRpcFXzFLu.png](../images/2020_06_07_LRpcFXzFLu.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸ª falseï¼Œå…¶å®æ˜¯åœ¨ä»£ç ä¼˜åŒ–é˜¶æ®µ(opt)ç›´æ¥è¢«ç¼–è¯‘åç«¯ä½œä¸ºå¸¸é‡ä¼˜åŒ–æ‰äº†ï¼Œç›´æ¥è½¬æˆäº† falseã€‚

æ‰€ä»¥æˆ‘ä»¬æœ¬èƒ½åœ°ä»¥ä¸º == æ˜¯åœ¨åšæŒ‡é’ˆæ¯”è¾ƒï¼Œä½†æ˜¯å¸¸é‡ä¼˜åŒ–ä¼šæ›¿æˆ‘ä»¬åšå‡ºä¸é‚£ä¹ˆç¬¦åˆç›´è§‰çš„åˆ¤æ–­ï¼Œç›´æ¥æŠŠ a == b rewrite ä¸º falseã€‚

é—®é¢˜åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“è¿™é‡Œæ˜¯ä¼˜åŒ–é˜¶æ®µåšçš„ï¼Œé‚£æ˜¯ä¸æ˜¯æˆ‘ä»¬æŠŠä¼˜åŒ–å…³é—­å°±ä¼šå¯¼è‡´è¾“å‡º true å‘¢ï¼Ÿ

ç¡®å®æ˜¯çš„ï¼š

```
~/test git:master â¯â¯â¯ cat true.go                                             

package main

import "fmt"

func main() {
	a := new(struct{})
	b := new(struct{})
	println(a, b, a == b)

	c := new(struct{})
	d := new(struct{})
	fmt.Println(c, d, c == d)
}

~/test git:master â¯â¯â¯ go run -gcflags="-N -l" true.go 

0xc00007aece 0xc00007aece true
&{} &{} true
```

PSï¼šå†™è¿™ä¸ªåªæ˜¯å›¾ä¸ªä¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Go é™„å¸¦çš„ SSA å·¥å…·å»æ›´æ·±å…¥åœ°è®¤è¯†æ•´ä¸ªç¼–è¯‘é˜¶æ®µå¹²çš„äº‹æƒ…ï¼Œä»è€Œç†è§£å®˜æ–¹çš„æ‰€è°“â€œå®ç°ç»†èŠ‚â€å’Œ spec ä¸Šçš„ may or may not åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ã€‚

**è¦æ˜¯å“ªä½å·¥ç¨‹å¸ˆæ‹¿è¿™ä¸ªå»åšé¢è¯•é¢˜ï¼Œé‚£å°±å¤ªç¼ºå¾·å•¦ï¼**(çœŸå®ğŸ¤£)