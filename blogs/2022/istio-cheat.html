<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>istio 速查表 | DUC&#39;S Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="何时才能暴富">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a5fc1f3a.css" as="style"><link rel="preload" href="/assets/js/app.4c3b9d5c.js" as="script"><link rel="preload" href="/assets/js/5.42a81560.js" as="script"><link rel="preload" href="/assets/js/1.77f0e2a2.js" as="script"><link rel="preload" href="/assets/js/16.10f43882.js" as="script"><link rel="prefetch" href="/assets/js/10.fe983c47.js"><link rel="prefetch" href="/assets/js/100.93329dd6.js"><link rel="prefetch" href="/assets/js/101.843da4d0.js"><link rel="prefetch" href="/assets/js/102.fa29c7b3.js"><link rel="prefetch" href="/assets/js/103.81e7b51f.js"><link rel="prefetch" href="/assets/js/104.7e81a5ae.js"><link rel="prefetch" href="/assets/js/105.a2381821.js"><link rel="prefetch" href="/assets/js/106.c3190b65.js"><link rel="prefetch" href="/assets/js/107.448a2664.js"><link rel="prefetch" href="/assets/js/108.33d58b32.js"><link rel="prefetch" href="/assets/js/109.877eeccc.js"><link rel="prefetch" href="/assets/js/11.fad29b69.js"><link rel="prefetch" href="/assets/js/110.1fdadea1.js"><link rel="prefetch" href="/assets/js/111.5aafdc13.js"><link rel="prefetch" href="/assets/js/112.b72c8913.js"><link rel="prefetch" href="/assets/js/113.c99838af.js"><link rel="prefetch" href="/assets/js/114.97981133.js"><link rel="prefetch" href="/assets/js/115.b2689a56.js"><link rel="prefetch" href="/assets/js/116.3f26c7f1.js"><link rel="prefetch" href="/assets/js/117.08d86b3d.js"><link rel="prefetch" href="/assets/js/118.a10c0b3d.js"><link rel="prefetch" href="/assets/js/119.da1d5eb9.js"><link rel="prefetch" href="/assets/js/12.2f295253.js"><link rel="prefetch" href="/assets/js/120.a01e39f0.js"><link rel="prefetch" href="/assets/js/121.d5fdb799.js"><link rel="prefetch" href="/assets/js/122.38176ce1.js"><link rel="prefetch" href="/assets/js/123.cb8659ee.js"><link rel="prefetch" href="/assets/js/124.ffca240a.js"><link rel="prefetch" href="/assets/js/125.45025220.js"><link rel="prefetch" href="/assets/js/126.e70619c9.js"><link rel="prefetch" href="/assets/js/127.80436e51.js"><link rel="prefetch" href="/assets/js/128.5ee2d458.js"><link rel="prefetch" href="/assets/js/129.e82d4765.js"><link rel="prefetch" href="/assets/js/13.a5d69620.js"><link rel="prefetch" href="/assets/js/130.ae6a65c5.js"><link rel="prefetch" href="/assets/js/131.fb00adce.js"><link rel="prefetch" href="/assets/js/132.11d0bf15.js"><link rel="prefetch" href="/assets/js/133.7cb4459a.js"><link rel="prefetch" href="/assets/js/134.b69e6ac7.js"><link rel="prefetch" href="/assets/js/135.fe54e11b.js"><link rel="prefetch" href="/assets/js/136.af0d5941.js"><link rel="prefetch" href="/assets/js/137.1e170174.js"><link rel="prefetch" href="/assets/js/138.e767d978.js"><link rel="prefetch" href="/assets/js/139.287753ae.js"><link rel="prefetch" href="/assets/js/14.62511239.js"><link rel="prefetch" href="/assets/js/140.f9838aa8.js"><link rel="prefetch" href="/assets/js/141.43b7ab5b.js"><link rel="prefetch" href="/assets/js/142.76b755f4.js"><link rel="prefetch" href="/assets/js/143.6960a5a9.js"><link rel="prefetch" href="/assets/js/144.90ff747e.js"><link rel="prefetch" href="/assets/js/145.80f708ab.js"><link rel="prefetch" href="/assets/js/146.ce06e25e.js"><link rel="prefetch" href="/assets/js/147.65e76c00.js"><link rel="prefetch" href="/assets/js/148.f58e72d8.js"><link rel="prefetch" href="/assets/js/149.e559a17a.js"><link rel="prefetch" href="/assets/js/15.ea731939.js"><link rel="prefetch" href="/assets/js/150.6332c9fa.js"><link rel="prefetch" href="/assets/js/151.f5767e2a.js"><link rel="prefetch" href="/assets/js/152.6f31f692.js"><link rel="prefetch" href="/assets/js/153.b6163e53.js"><link rel="prefetch" href="/assets/js/154.6244a7a1.js"><link rel="prefetch" href="/assets/js/155.d4a5bb53.js"><link rel="prefetch" href="/assets/js/156.27ea7524.js"><link rel="prefetch" href="/assets/js/157.ee611a1c.js"><link rel="prefetch" href="/assets/js/158.a74fc4fc.js"><link rel="prefetch" href="/assets/js/159.3b00fc6a.js"><link rel="prefetch" href="/assets/js/160.a01545c9.js"><link rel="prefetch" href="/assets/js/161.2a8494d2.js"><link rel="prefetch" href="/assets/js/162.4f3575a2.js"><link rel="prefetch" href="/assets/js/163.2ad5597e.js"><link rel="prefetch" href="/assets/js/164.7d14299f.js"><link rel="prefetch" href="/assets/js/165.4be0f4af.js"><link rel="prefetch" href="/assets/js/166.35f1aac0.js"><link rel="prefetch" href="/assets/js/167.b140379f.js"><link rel="prefetch" href="/assets/js/168.835acbe0.js"><link rel="prefetch" href="/assets/js/169.c7bf9cec.js"><link rel="prefetch" href="/assets/js/17.1632bfad.js"><link rel="prefetch" href="/assets/js/170.eb871a7b.js"><link rel="prefetch" href="/assets/js/171.730fd2c9.js"><link rel="prefetch" href="/assets/js/172.b879ac8f.js"><link rel="prefetch" href="/assets/js/173.26d15199.js"><link rel="prefetch" href="/assets/js/174.c587fe83.js"><link rel="prefetch" href="/assets/js/175.117a06df.js"><link rel="prefetch" href="/assets/js/176.afc90015.js"><link rel="prefetch" href="/assets/js/177.fde66a9f.js"><link rel="prefetch" href="/assets/js/178.c57e5880.js"><link rel="prefetch" href="/assets/js/179.c392f5ac.js"><link rel="prefetch" href="/assets/js/18.7e38f777.js"><link rel="prefetch" href="/assets/js/180.01a18436.js"><link rel="prefetch" href="/assets/js/181.8b20c10f.js"><link rel="prefetch" href="/assets/js/19.d65709b0.js"><link rel="prefetch" href="/assets/js/20.ac27961c.js"><link rel="prefetch" href="/assets/js/21.dad8650a.js"><link rel="prefetch" href="/assets/js/22.e4f93a86.js"><link rel="prefetch" href="/assets/js/23.70b0da30.js"><link rel="prefetch" href="/assets/js/24.c8e4f393.js"><link rel="prefetch" href="/assets/js/25.21ed46fe.js"><link rel="prefetch" href="/assets/js/26.e1ca4e6f.js"><link rel="prefetch" href="/assets/js/27.963758aa.js"><link rel="prefetch" href="/assets/js/28.bbf20355.js"><link rel="prefetch" href="/assets/js/29.8af24673.js"><link rel="prefetch" href="/assets/js/3.ab35018f.js"><link rel="prefetch" href="/assets/js/30.da4b7944.js"><link rel="prefetch" href="/assets/js/31.df19a6fd.js"><link rel="prefetch" href="/assets/js/32.45ea6fc8.js"><link rel="prefetch" href="/assets/js/33.9a7b2150.js"><link rel="prefetch" href="/assets/js/34.77a51303.js"><link rel="prefetch" href="/assets/js/35.c98a568e.js"><link rel="prefetch" href="/assets/js/36.098ac37f.js"><link rel="prefetch" href="/assets/js/37.f8e24daf.js"><link rel="prefetch" href="/assets/js/38.30ffc24b.js"><link rel="prefetch" href="/assets/js/39.3d465d47.js"><link rel="prefetch" href="/assets/js/4.3063c18c.js"><link rel="prefetch" href="/assets/js/40.221732d0.js"><link rel="prefetch" href="/assets/js/41.571032ac.js"><link rel="prefetch" href="/assets/js/42.1da2e35f.js"><link rel="prefetch" href="/assets/js/43.e8c113fb.js"><link rel="prefetch" href="/assets/js/44.9acf20eb.js"><link rel="prefetch" href="/assets/js/45.b849d0fb.js"><link rel="prefetch" href="/assets/js/46.e9fc9612.js"><link rel="prefetch" href="/assets/js/47.51f1ae83.js"><link rel="prefetch" href="/assets/js/48.929cd91b.js"><link rel="prefetch" href="/assets/js/49.99e23be5.js"><link rel="prefetch" href="/assets/js/50.fe10f20e.js"><link rel="prefetch" href="/assets/js/51.beec6026.js"><link rel="prefetch" href="/assets/js/52.02ed9936.js"><link rel="prefetch" href="/assets/js/53.b244c4a3.js"><link rel="prefetch" href="/assets/js/54.10368b35.js"><link rel="prefetch" href="/assets/js/55.c2b8c795.js"><link rel="prefetch" href="/assets/js/56.2fb224c7.js"><link rel="prefetch" href="/assets/js/57.8481e893.js"><link rel="prefetch" href="/assets/js/58.3a83d387.js"><link rel="prefetch" href="/assets/js/59.f96d625d.js"><link rel="prefetch" href="/assets/js/6.6b163ae0.js"><link rel="prefetch" href="/assets/js/60.d4a1e374.js"><link rel="prefetch" href="/assets/js/61.b2062db2.js"><link rel="prefetch" href="/assets/js/62.0fdbbe3e.js"><link rel="prefetch" href="/assets/js/63.5bba3aaf.js"><link rel="prefetch" href="/assets/js/64.ca15ea67.js"><link rel="prefetch" href="/assets/js/65.82a7be95.js"><link rel="prefetch" href="/assets/js/66.62eb0e42.js"><link rel="prefetch" href="/assets/js/67.db6b1f81.js"><link rel="prefetch" href="/assets/js/68.ece940ca.js"><link rel="prefetch" href="/assets/js/69.c6a12f4a.js"><link rel="prefetch" href="/assets/js/7.28d05c1f.js"><link rel="prefetch" href="/assets/js/70.ef3073fe.js"><link rel="prefetch" href="/assets/js/71.defd9ebf.js"><link rel="prefetch" href="/assets/js/72.b2277e4e.js"><link rel="prefetch" href="/assets/js/73.630609b1.js"><link rel="prefetch" href="/assets/js/74.3d1507d0.js"><link rel="prefetch" href="/assets/js/75.a35d33df.js"><link rel="prefetch" href="/assets/js/76.a8db2b7f.js"><link rel="prefetch" href="/assets/js/77.79741667.js"><link rel="prefetch" href="/assets/js/78.cfd05069.js"><link rel="prefetch" href="/assets/js/79.807f6fcf.js"><link rel="prefetch" href="/assets/js/8.59e3eaf0.js"><link rel="prefetch" href="/assets/js/80.83b50d82.js"><link rel="prefetch" href="/assets/js/81.ebf54785.js"><link rel="prefetch" href="/assets/js/82.bd035c55.js"><link rel="prefetch" href="/assets/js/83.fdfe6663.js"><link rel="prefetch" href="/assets/js/84.ad24491b.js"><link rel="prefetch" href="/assets/js/85.416d4dc2.js"><link rel="prefetch" href="/assets/js/86.4ec414ec.js"><link rel="prefetch" href="/assets/js/87.c35a3a22.js"><link rel="prefetch" href="/assets/js/88.bd43f2bf.js"><link rel="prefetch" href="/assets/js/89.8077a111.js"><link rel="prefetch" href="/assets/js/9.cf139049.js"><link rel="prefetch" href="/assets/js/90.21366f63.js"><link rel="prefetch" href="/assets/js/91.23e54bf0.js"><link rel="prefetch" href="/assets/js/92.9d582183.js"><link rel="prefetch" href="/assets/js/93.6cc7928f.js"><link rel="prefetch" href="/assets/js/94.bc621ef1.js"><link rel="prefetch" href="/assets/js/95.2c7524ca.js"><link rel="prefetch" href="/assets/js/96.0f8f598a.js"><link rel="prefetch" href="/assets/js/97.8fde4240.js"><link rel="prefetch" href="/assets/js/98.176f9256.js"><link rel="prefetch" href="/assets/js/99.95bf4709.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a5fc1f3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>duc</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>duc's blog</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>duc</span>
            
          <span data-v-4e82dffc>2018 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="DUC'S Blog" class="logo"> <span class="site-name">DUC'S Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/书籍/" class="nav-link"><i class="undefined"></i>
  书籍
</a></li><li class="dropdown-item"><!----> <a href="/categories/计划/" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/未来/" class="nav-link"><i class="undefined"></i>
  未来
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duc-cnZj" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    duc
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>171</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>150</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/书籍/" class="nav-link"><i class="undefined"></i>
  书籍
</a></li><li class="dropdown-item"><!----> <a href="/categories/计划/" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/未来/" class="nav-link"><i class="undefined"></i>
  未来
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duc-cnZj" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>istio 速查表</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>duc</span>
            
          <span data-v-4e82dffc>2018 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">istio 速查表</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>duc</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2022/10/10</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/blogs/2022/istio-cheat.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>istio</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="istio"><a href="#istio" class="header-anchor">#</a> istio</h1> <blockquote><p>当前版本 <code>1.15.1</code></p></blockquote> <p><img src="/assets/img/image-20220923145218270.fb8222da.png" alt="image-20220923145218270"></p> <h2 id="查看集群中都安装了什么"><a href="#查看集群中都安装了什么" class="header-anchor">#</a> 查看集群中都安装了什么</h2> <blockquote><p>拿到的就是 <code>IstioOperator</code> 的yaml清单</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl -n istio-system get IstioOperator installed-state -o yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="查看-打印-profile"><a href="#查看-打印-profile" class="header-anchor">#</a> 查看/打印 profile</h2> <blockquote><p>dump 出来的就是 IstioOperator  文件</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>istioctl profile list
》Istio configuration profiles:
    default
    demo
    empty
    external
    minimal
    openshift
    preview

istioctl profile dump demo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="查看-istiooperator-差异"><a href="#查看-istiooperator-差异" class="header-anchor">#</a> 查看 IstioOperator 差异</h2> <blockquote><p>kubectl -n istio-system get IstioOperator installed-state -o yaml  用这个生成现在集群的配置，然后和你本地的比较</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>istioctl manifest <span class="token function">diff</span> istio.yaml /tmp/istio-1422.yml
<span class="token comment"># 后面的比前面的多了</span>

》Differences <span class="token keyword">in</span> manifests are:


Object IstioOperator:: has diffs:

spec:
  components:
    pilot:
      k8s: <span class="token operator">&lt;</span>empty<span class="token operator">&gt;</span> -<span class="token operator">&gt;</span> map<span class="token punctuation">[</span>hpaSpec:map<span class="token punctuation">[</span>maxReplicas:5 metrics:<span class="token punctuation">[</span>map<span class="token punctuation">[</span>resource:map<span class="token punctuation">[</span>name:cpu
        target:map<span class="token punctuation">[</span>averageUtilization:80 type:Utilization<span class="token punctuation">]</span><span class="token punctuation">]</span> type:Resource<span class="token punctuation">]</span><span class="token punctuation">]</span> minReplicas:1
        scaleTargetRef:map<span class="token punctuation">[</span>apiVersion:apps/v1 kind:Deployment name:istiod<span class="token punctuation">]</span><span class="token punctuation">]</span> replicaCount:1<span class="token punctuation">]</span>
        <span class="token punctuation">(</span>ADDED<span class="token punctuation">)</span>
  values:
    global:
      proxy:
        resources:
          limits: <span class="token operator">&lt;</span>empty<span class="token operator">&gt;</span> -<span class="token operator">&gt;</span> map<span class="token punctuation">[</span>cpu:2000m memory:1024Mi<span class="token punctuation">]</span> <span class="token punctuation">(</span>ADDED<span class="token punctuation">)</span>
      proxy_init:
        resources:
          limits: <span class="token operator">&lt;</span>empty<span class="token operator">&gt;</span> -<span class="token operator">&gt;</span> map<span class="token punctuation">[</span>cpu:2000m memory:1024Mi<span class="token punctuation">]</span> <span class="token punctuation">(</span>ADDED<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="检查安装是否成功"><a href="#检查安装是否成功" class="header-anchor">#</a> 检查安装是否成功</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>istioctl verify-install -f istio.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="新增一个-ingress-gateway"><a href="#新增一个-ingress-gateway" class="header-anchor">#</a> 新增一个 ingress gateway</h2> <blockquote><p>https://istio.io/latest/zh/docs/setup/install/istioctl/#configure-gateways</p></blockquote> <h2 id="自动注入-sidecar"><a href="#自动注入-sidecar" class="header-anchor">#</a> 自动注入 sidecar</h2> <blockquote><p>注意是在 labels 里面加！不是注解里面</p> <p><a href="https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#controlling-the-injection-policy" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><img src="/assets/img/image-20220923145412512.c41aa511.png" alt="image-20220923145412512"></p> <hr> <h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <h3 id="基于身份路由"><a href="#基于身份路由" class="header-anchor">#</a> 基于身份路由</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 基于身份路由 </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
<span class="token comment"># When gateways is omitted, the default gateway (mesh) will be used, 没填这个字段默认使用 mesh</span>
<span class="token comment">#  gateways:</span>
<span class="token comment">#  - mesh</span>
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
  <span class="token comment"># 规则是 '&amp;' 关系, header 包含 user: duc, 并且访问的是 /web.html 去到 v1 服务</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> duc
      <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/web.html&quot;</span>
      <span class="token key atrule">ignoreUriCase</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="注入-http-abort-延迟-故障注入"><a href="#注入-http-abort-延迟-故障注入" class="header-anchor">#</a> 注入 HTTP abort/延迟 故障注入</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 让 user: duc 的访问返回 504</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span> 
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">504</span>
    <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> duc
      <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/web.html&quot;</span>
      <span class="token key atrule">ignoreUriCase</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 让 user: duc 的访问延迟 3s</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 3s
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span> 
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> duc
      <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/web.html&quot;</span>
      <span class="token key atrule">ignoreUriCase</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="流量管理"><a href="#流量管理" class="header-anchor">#</a> 流量管理</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 5% 到 v1 </span>
<span class="token comment"># 95% 到 v2</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">95</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="请求超时设置"><a href="#请求超时设置" class="header-anchor">#</a> 请求超时设置</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 2ms
      <span class="token key atrule">route</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> web
          <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr> <h2 id="熔断"><a href="#熔断" class="header-anchor">#</a> 熔断</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
   <span class="token comment"># 最短弹射时间。主机将保持被弹出的时间等于最小弹出持续时间与主机被弹出次数的乘积。这种技术允许系统自动增加不健康的上游服务器的弹出周期。格式：1h/1m/1s/1ms。必须 &gt;=1 毫秒。默认为 30 秒</span>
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token comment"># 主机从连接池中弹出之前的 5xx 错误数。当通过不透明的 TCP 连接访问上游主机时，连接超时、连接错误/失败和请求失败事件符合 5xx 错误。此功能默认为 5，但可以通过将值设置为 0 来禁用。</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment"># 喷射扫描分析之间的时间间隔。格式：1h/1m/1s/1ms。必须 &gt;=1 毫秒。默认为 10 秒。</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token comment"># 上游服务的负载平衡池中可以弹出的主机的最大百分比。默认为 10%。</span>
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="流量镜像"><a href="#流量镜像" class="header-anchor">#</a> 流量镜像</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> 
      <span class="token key atrule">route</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> web
          <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">mirrorPercentage</span><span class="token punctuation">:</span> 
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="地域流量权重分配"><a href="#地域流量权重分配" class="header-anchor">#</a> 地域流量权重分配</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 来自 zone-b 的流量到 b，来自 zone-a 的到 a</span>
<span class="token comment"># 百分比不能为 0</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> web
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">localityLbSetting</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">distribute</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span>1/zone<span class="token punctuation">-</span>b/*
          <span class="token key atrule">to</span><span class="token punctuation">:</span>
            <span class="token key atrule">&quot;region-1/zone-a/*&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">&quot;region-1/zone-b/*&quot;</span><span class="token punctuation">:</span> <span class="token number">99</span>
        <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span>1/zone<span class="token punctuation">-</span>a/*
          <span class="token key atrule">to</span><span class="token punctuation">:</span>
            <span class="token key atrule">&quot;region-1/zone-a/*&quot;</span><span class="token punctuation">:</span> <span class="token number">99</span>
            <span class="token key atrule">&quot;region-1/zone-b/*&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> route<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> web
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> web
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="地域故障转移-todo-开三个node验证"><a href="#地域故障转移-todo-开三个node验证" class="header-anchor">#</a> 地域故障转移(TODO: 开三个node验证)</h3> <blockquote><p>配了这个后，流量只会到 region-1 中，除非配置成多个, 如下</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>      <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">1</span>
        <span class="token key atrule">to</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">2</span>
      <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">2</span>
        <span class="token key atrule">to</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> web
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
      <span class="token key atrule">localityLbSetting</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># 如果没有指定 OutlierDetection，这将不会生效。</span>
        <span class="token key atrule">failover</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">1</span>
            <span class="token key atrule">to</span><span class="token punctuation">:</span> region<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 1m
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><hr> <h3 id="使用-istio-gateway-配置-ingress"><a href="#使用-istio-gateway-配置-ingress" class="header-anchor">#</a> 使用 Istio Gateway 配置 Ingress</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>gw
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 一个或多个标签，指示应在其上应用此网关配置的一组特定 pod/VM。默认情况下，工作负载会根据标签选择器在所有命名空间中进行搜索。这意味着命名空间“foo”中的网关资源可以根据标签选择命名空间“bar”中的 pod。这种行为可以通过PILOT_SCOPE_GATEWAY_TO_NAMESPACE istiod 中的环境变量来控制。如果此变量设置为 true，则标签搜索的范围仅限于资源所在的配置命名空间。换言之，网关资源必须与网关工作负载实例位于相同的命名空间中。如果选择器为 nil，则网关将应用于所有工作负载。</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
    <span class="token key atrule">service.istio.io/canonical-name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>gateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;web.my.local&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="https-ingress-gateway"><a href="#https-ingress-gateway" class="header-anchor">#</a> HTTPS ingress gateway</h3> <blockquote><p>kubectl create -n istio-system secret <strong>tls</strong></p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>gw
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
    <span class="token key atrule">service.istio.io/canonical-name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>gateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>secret
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;web.k8s.local&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="为同一个gateway配置多个https证书"><a href="#为同一个gateway配置多个https证书" class="header-anchor">#</a> 为同一个gateway配置多个https证书</h3> <blockquote><p>为多个主机配置 TLS 入口网关</p> <p>kubectl create -n istio-system secret <strong>tls</strong></p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>gw
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
    <span class="token key atrule">service.istio.io/canonical-name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>gateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>local
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>secret
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;web.k8s.local&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>my<span class="token punctuation">-</span>local
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>local
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*.my.local&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="配置双向-tls-入口网关"><a href="#配置双向-tls-入口网关" class="header-anchor">#</a> 配置双向 TLS 入口网关</h3> <blockquote><p>这里创建的 tls secret 不是 tls 类型</p> <p>kubectl create -n istio-system secret <strong>generic</strong></p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>gw
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> duc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
    <span class="token key atrule">service.istio.io/canonical-name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>gateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>my<span class="token punctuation">-</span>local
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token comment"># 这里从 simple 改成 mutual</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>local
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*.my.local&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>curl --resolve web.my.local:30265:192.168.247.10 https://web.my.local:30265/web.html --cacert $(pwd)/certs/ca.pem --key $(pwd)/certs/my-local-key.pem --cert $(pwd)/certs/my-local.pem</code></p> <p>因为普通 https 和双向 tls 证书里面差了一个 ca.crt, 因此istio可以使用下面的方法来兼容</p> <p>例如上面双向tls,也可以变成 my-local + my-local-cacert</p> <p>Istio 支持读取不同的 Secret 格式，以支持与各种工具（例如<a href="https://istio.io/latest/zh/docs/ops/integrations/certmanager/" target="_blank" rel="noopener noreferrer">cert-manager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)的集成：</p> <ul><li>如上所述，包含 <code>tls.key</code> 和 <code>tls.crt</code> 的 TLS secret。对于双向 TLS，可以使用 <code>ca.crt</code> 密钥。</li> <li>包含 <code>key</code> 和 <code>cert</code> 的通用 Secret。对于双向 TLS，可以使用 <code>cacert</code> 密钥。</li> <li>包含 <code>key</code> 和 <code>cert</code> 的通用 Secret。对于双向 TLS，还可以单独设置名为 <code>&lt;secret&gt;-cacert</code> 的通用 secret，该 secret 含 <code>cacert</code> 密钥。例如，<code>httpbin-credential</code> 包含 <code>key</code> 和 <code>cert</code>，而 <code>httpbin-credential-cacert</code> 包含 <code>cacert</code>。</li> <li><code>cacert</code> 密钥可以是由单个 CA 证书连接组成的 CA 包。</li></ul> <hr> <h3 id="https-透传"><a href="#https-透传" class="header-anchor">#</a> HTTPS 透传</h3> <blockquote><p>服务本身就 配置了 https 证书的情况</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> PASSTHROUGH
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> nginx.example.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nginx.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx.example.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><hr> <h2 id="管理到外部服务的流量"><a href="#管理到外部服务的流量" class="header-anchor">#</a> 管理到外部服务的流量</h2> <blockquote><p>配置 global.outboundTrafficPolicy.mode 为 REGISTRY_ONLY ，拒绝全部外部访问，默认是 ALLOW_ANY。</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 即使不再同一个ns也会生效</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> baidu<span class="token punctuation">-</span>ext
  <span class="token comment"># namespace: duc</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> www.baidu.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPs
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>ext
  <span class="token comment"># namespace: duc</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin.org
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="用于-egress-流量的-tls-发起"><a href="#用于-egress-流量的-tls-发起" class="header-anchor">#</a> 用于 egress 流量的 TLS 发起</h2> <blockquote><p>实验没做通，提示需要证书</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bilibili
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> www.bilibili.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bilibili<span class="token punctuation">-</span>ext
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> www.bilibili.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPs
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="定义-egress-gateway-并引导-http-流量"><a href="#定义-egress-gateway-并引导-http-流量" class="header-anchor">#</a> 定义 Egress gateway 并引导 HTTP 流量</h3> <blockquote><p>实验没做通, 官方示例有问题，提示unknown field &quot;sni_hosts&quot;</p></blockquote> <h2 id="egress-后面几章因为测试与实际不符没继续往下看"><a href="#egress-后面几章因为测试与实际不符没继续往下看" class="header-anchor">#</a> Egress 后面几章因为测试与实际不符没继续往下看</h2> <h2 id="traceing"><a href="#traceing" class="header-anchor">#</a> Traceing</h2> <blockquote><p><a href="https://istio.io/latest/zh/docs/tasks/observability/distributed-tracing/overview/" target="_blank" rel="noopener noreferrer">应用本身必须接入对应的 otel headers <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="自定义跟踪采样"><a href="#自定义跟踪采样" class="header-anchor">#</a> 自定义跟踪采样</h3> <blockquote><p>采样率应在 0.0 到 100.0 的范围内，精度为0.01</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">sampling</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://istio.io/latest/zh/docs/" target="_blank" rel="noopener noreferrer">
文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://istio.io/latest/zh/docs/tasks/" target="_blank" rel="noopener noreferrer">任务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://istio.io/latest/zh/docs/tasks/observability/" target="_blank" rel="noopener noreferrer">可观察性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://istio.io/latest/zh/docs/tasks/observability/distributed-tracing/" target="_blank" rel="noopener noreferrer">分布式追踪<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>使用 MeshConfig 和 Pod 注释配置跟踪</p> <h1 id="使用-meshconfig-和-pod-注释配置跟踪"><a href="#使用-meshconfig-和-pod-注释配置跟踪" class="header-anchor">#</a> 使用 MeshConfig 和 Pod 注释配置跟踪</h1> <p>阅读大约需要 2 分钟  <a href="https://github.com/istio/istio.io/tree/master/README.md#testing-document-content" target="_blank" rel="noopener noreferrer"> 页面测试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>鼓励用户使用 <a href="https://istio.io/latest/zh/docs/tasks/observability/telemetry/" target="_blank" rel="noopener noreferrer">Telemetry API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来跟踪配置。</p> <p>Istio 提供了配置高级跟踪选项的能力，例如采样率和向报告的跨度添加自定义标记。采样是一个 beta 特性，但是添加自定义标签和跟踪标签长度会考虑在本版本中开发。</p> <h2 id="开始之前"><a href="#开始之前" class="header-anchor">#</a> 开始之前</h2> <ol><li>确保您的应用程序按照 <a href="https://istio.io/latest/zh/docs/tasks/observability/distributed-tracing/overview/" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>所述传输追踪标头。</li> <li>遵循位于 <a href="https://istio.io/latest/zh/docs/ops/integrations/" target="_blank" rel="noopener noreferrer">Integrations<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 下的追踪安装指南，根据您喜欢的追踪后端安装适当的插件和配置您的 Istio 代理以将追踪发送到追踪部署。</li></ol> <h2 id="可用的跟踪配置"><a href="#可用的跟踪配置" class="header-anchor">#</a> 可用的跟踪配置</h2> <p>您可以在 Istio 中配置以下跟踪选项：</p> <ol><li>将选择用于跟踪生成的请求百分比的随机采样率。</li> <li>请求路径的最大长度，之后路径将被截断报告。这对于限制跟踪数据存储特别有用，如果您在入口网关收集跟踪。</li> <li>在spans中添加自定义标签。这些标签可以基于静态文字添加请求标头中的值、环境值或字段。这可以用来在特定于您的环境的跨度中注入其他信息。</li></ol> <p>有两种方法可以配置跟踪选项：</p> <ol><li>全局通过 <code>MeshConfig</code> 选项。</li> <li>用于工作负载特定定制的每个 pod 注释。</li></ol> <p>为了使新的跟踪配置对其中任何一个生效，您需要重新启动注入 Istio 代理的 pod 的选项。</p> <p>为跟踪配置而添加的任何 pod 注释都会覆盖全局设置。为了保留任何全局设置，你应该将它们从全局网格配置复制到 pod 注释，并进行特定于工作负载的定制。特别是要确保注释中始终提供跟踪后端地址，以确保正确地报告工作负载的跟踪。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>使用这些特性为在您的环境中管理跟踪提供了新的可能性。</p> <p>在本例中，我们将对所有跟踪进行采样，并添加一个名为 <code>clusterID</code> 的标记，使用 <code>ISTIO_META_CLUSTER_ID</code> 环境变量注入到您的 pod。只使用该值的前 256 个字符。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ cat &lt;&lt;EOF &gt; ./tracing.yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    enableTracing: true
    defaultConfig:
      tracing:
        sampling: 100.0
        max_path_tag_length: 256
        custom_tags:
          clusterID:
          environment:
            name: ISTIO_META_CLUSTER_ID
EOF
$ istioctl install -f ./tracing.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="使用-meshconfig-进行跟踪设置"><a href="#使用-meshconfig-进行跟踪设置" class="header-anchor">#</a> 使用 MeshConfig 进行跟踪设置</h3> <p>所有跟踪选项都可以通过 <code>MeshConfig</code> 全局配置。 为了简化配置，建议创建一个可以传递给 <code>istioctl install -f</code> 命令的 YAML 文件。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat &lt;&lt;'EOF' <span class="token punctuation">&gt;</span> tracing.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">sampling</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">custom_tags</span><span class="token punctuation">:</span>
          <span class="token key atrule">my_tag_header</span><span class="token punctuation">:</span>
            <span class="token key atrule">header</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> host
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="使用-proxy-istio-io-config-跟踪设置的注释"><a href="#使用-proxy-istio-io-config-跟踪设置的注释" class="header-anchor">#</a> 使用 <code>proxy.istio.io/config</code> 跟踪设置的注释</h3> <p>您可以添加 <code>proxy.istio.io/config</code> 注释到您的 Pod 元数据规范，以覆盖任何网格范围的跟踪设置。 例如，要修改 Istio 附带的 <code>sleep</code> 部署，你需要在 <code>samples/sleep/sleep.yaml</code> 中添加以下内容:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token punctuation">...</span>
        <span class="token key atrule">proxy.istio.io/config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          tracing:
            sampling: 10
            custom_tags:
              my_tag_header:
                header:
                  name: host</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="自定义跟踪采样-2"><a href="#自定义跟踪采样-2" class="header-anchor">#</a> 自定义跟踪采样</h2> <p>采样率选项可用于控制向跟踪系统报告的请求的百分比。这应该根据网格中的通信量和想要收集的跟踪数据量进行配置。默认值为 1%。</p> <p>以前，推荐的方法是在网格设置期间更改 <code>values.pilot.traceSampling</code> 设置，或在 pilot 或 istiod 部署中更改 <code>PILOT_TRACE_SAMPLE</code> 环境变量。</p> <p>虽然这种改变抽样的方法仍然有效，但强烈建议改用以下方法</p> <p>要将默认随机抽样修改为50，请在 <code>tracing.yaml</code> 文件中添加以下选项。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">sampling</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>采样率应在 0.0 到 100.0 的范围内，精度为0.01。 例如，要跟踪每 10000 个请求中的 5 个，使用 0.05 作为这里的值。</p> <h3 id="定制跟踪标签"><a href="#定制跟踪标签" class="header-anchor">#</a> 定制跟踪标签</h3> <p>可以根据文字、环境变量和客户端请求标头向跨度添加自定义标记</p> <h5 id="literal-表示添加到每个-span-的静态值。"><a href="#literal-表示添加到每个-span-的静态值。" class="header-anchor">#</a> Literal 表示添加到每个 span 的静态值。</h5> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">custom_tags</span><span class="token punctuation">:</span>
          <span class="token key atrule">my_tag_literal</span><span class="token punctuation">:</span>
            <span class="token key atrule">literal</span><span class="token punctuation">:</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> &lt;VALUE<span class="token punctuation">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="在从工作负载代理环境变量填充自定义标记的值时-可以使用环境变量。"><a href="#在从工作负载代理环境变量填充自定义标记的值时-可以使用环境变量。" class="header-anchor">#</a> 在从工作负载代理环境变量填充自定义标记的值时，可以使用环境变量。</h5> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">custom_tags</span><span class="token punctuation">:</span>
          <span class="token key atrule">my_tag_env</span><span class="token punctuation">:</span>
            <span class="token key atrule">environment</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;ENV_VARIABLE_NAME<span class="token punctuation">&gt;</span>
              <span class="token key atrule">defaultValue</span><span class="token punctuation">:</span> &lt;VALUE<span class="token punctuation">&gt;</span>      <span class="token comment"># optional</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="客户端请求头选项可用于填充来自传入客户端请求头的标记值。"><a href="#客户端请求头选项可用于填充来自传入客户端请求头的标记值。" class="header-anchor">#</a> 客户端请求头选项可用于填充来自传入客户端请求头的标记值。</h5> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> install.istio.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IstioOperator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">enableTracing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">tracing</span><span class="token punctuation">:</span>
        <span class="token key atrule">custom_tags</span><span class="token punctuation">:</span>
          <span class="token key atrule">my_tag_header</span><span class="token punctuation">:</span>
            <span class="token key atrule">header</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;CLIENT<span class="token punctuation">-</span>HEADER<span class="token punctuation">&gt;</span>
              <span class="token key atrule">defaultValue</span><span class="token punctuation">:</span> &lt;VALUE<span class="token punctuation">&gt;</span>      <span class="token comment"># optional</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="kiali"><a href="#kiali" class="header-anchor">#</a> kiali</h2> <p><a href="https://istio.io/latest/zh/docs/tasks/observability/kiali/" target="_blank" rel="noopener noreferrer">kiali 可视化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="安全模块没看"><a href="#安全模块没看" class="header-anchor">#</a> 安全模块没看</h2> <h3 id="全局以严格模式启用-istio-双向-tls"><a href="#全局以严格模式启用-istio-双向-tls" class="header-anchor">#</a> 全局以严格模式启用 Istio 双向 TLS</h3> <blockquote><p>启用后所有pod访问svc都要tls</p> <p>没有 sidecar 的 pod 访问不了有 sidecar 的 pod</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;istio-system&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="为每个命名空间或者工作负载启用双向-tls"><a href="#为每个命名空间或者工作负载启用双向-tls" class="header-anchor">#</a> 为每个命名空间或者工作负载启用双向 TLS</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
EOF

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="为每个工作负载启用双向-tls"><a href="#为每个工作负载启用双向-tls" class="header-anchor">#</a> 为每个工作负载启用双向 TLS</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 以下对等身份验证策略要求在除 80 端口以外的所有端口上都使用双向 TLS</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;strict-tls&quot;</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;mesh&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># pod label selector</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>two
  <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
  <span class="token key atrule">portLevelMtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">80</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> DISABLE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="策略优先级"><a href="#策略优先级" class="header-anchor">#</a> 策略优先级</h3> <p>特定服务策略 &gt; <code>namespace</code> &gt; <code>istio-system</code></p> <h1 id="运维"><a href="#运维" class="header-anchor">#</a> 运维</h1> <h2 id="应用程序要求"><a href="#应用程序要求" class="header-anchor">#</a> <a href="https://istio.io/latest/zh/docs/ops/deployment/requirements/" target="_blank" rel="noopener noreferrer">应用程序要求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>作为 Istio 服务网格中的一部分，Kubernetes 集群中的 Pod 和 Service 必须满足以下要求：</p> <ul><li><strong>命名的服务端口</strong>: Service 的端口必须命名。端口名键值对必须按以下格式：<code>name: &lt;protocol&gt;[-&lt;suffix&gt;]</code>。更多说明请参看<a href="https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/" target="_blank" rel="noopener noreferrer">协议选择<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li><strong>Service 关联</strong>: 每个 Pod 必须至少属于一个 Kubernetes Service，不管这个 Pod 是否对外暴露端口。如果一个 Pod 同时属于多个 <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer">Kubernetes Service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 那么这些 Service 不能同时在一个端口号上使用不同的协议（比如：HTTP 和 TCP）。</li> <li><font color="red"><strong>带有 app 和 version 标签（label）的 Deployment</strong></font>: 我们建议显式地给 Deployment 加上 <code>app</code> 和 <code>version</code> 标签。给使用 Kubernetes <code>Deployment</code> 部署的 Pod 部署配置中增加这些标签，可以给 Istio 收集的指标和遥测信息中增加上下文信息。
<ul><li><code>app</code> 标签：每个部署配置应该有一个不同的 <code>app</code> 标签并且该标签的值应该有一定意义。<code>app</code> label 用于在分布式追踪中添加上下文信息。</li> <li><code>version</code> 标签：这个标签用于在特定方式部署的应用中表示版本。</li></ul></li> <li><strong>应用 UID</strong>: 确保你的 Pod 不会以 ID（UID）为 <code>1337</code> 的用户运行应用，因为 <code>1337</code> 是为 Sidecar 代理保留的。</li> <li><strong><code>NET_ADMIN</code> 功能</strong>: 如果你的集群执行 Pod 安全策略，必须给 Pod 配置 <code>NET_ADMIN</code> 功能。如果你使用 <a href="https://istio.io/latest/zh/docs/setup/additional-setup/cni/" target="_blank" rel="noopener noreferrer">Istio CNI 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以不配置。要了解更多 <code>NET_ADMIN</code> 功能的知识，请查看<a href="https://istio.io/latest/zh/docs/ops/deployment/requirements/#required-pod-capabilities" target="_blank" rel="noopener noreferrer">所需的 Pod 功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <p><img src="/assets/img/image-20220928111110585.dc98430b.png" alt="image-20220928111110585"></p> <p><img src="/assets/img/image-20220928110925005.aa0ba5af.png" alt="image-20220928110925005"></p> <p><img src="/assets/img/image-20220928110933063.488726a4.png" alt="image-20220928110933063"></p> <h1 id="gateway"><a href="#gateway" class="header-anchor">#</a> Gateway</h1> <h3 id="x-forwarded-for"><a href="#x-forwarded-for" class="header-anchor">#</a> X-Forwarded-For</h3> <blockquote><p>https://istio.io/latest/zh/docs/ops/configuration/traffic-management/network-topologies/</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">meshConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">defaultConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">gatewayTopology</span><span class="token punctuation">:</span>
        <span class="token key atrule">numTrustedProxies</span><span class="token punctuation">:</span> &lt;VALUE<span class="token punctuation">&gt;</span>
        <span class="token key atrule">forwardClientCertDetails</span><span class="token punctuation">:</span> &lt;ENUM_VALUE<span class="token punctuation">&gt;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>or 在您的 Istio Ingress Gateway Pod 的 Spec 通过添加 <code>proxy.istio.io/config</code> 注解可以来设置这两个配置。or</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;proxy.istio.io/config&quot;</span><span class="token punctuation">:</span> <span class="token string">'{&quot;gatewayTopology&quot; : { &quot;numTrustedProxies&quot;: &lt;VALUE&gt;, &quot;forwardClientCertDetails&quot;: &lt;ENUM_VALUE&gt; } }'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="httpbin-x-forwarded-for-示例"><a href="#httpbin-x-forwarded-for-示例" class="header-anchor">#</a> httpbin X-Forwarded-For 示例</h4> <blockquote><p>实验没做，因为 httpbin 镜像没兼容 arm64</p></blockquote> <hr> <h2 id="最佳实践"><a href="#最佳实践" class="header-anchor">#</a> 最佳实践</h2> <h3 id="避免重新配置服务路由时出现-503-错误"><a href="#避免重新配置服务路由时出现-503-错误" class="header-anchor">#</a> 避免重新配置服务路由时出现 503 错误</h3> <p>在设置路由规则以将流量定向到服务的某个版本（子集）时，必须注意确保子集在路由中使用之前是可用的。否则，在重新配置期间，对服务的调用可能返回 503 错误。</p> <p>使用单个 <code>kubectl</code> 调用（例如，<code>kubectl apply -f myVirtualServiceAndDestinationRule.yaml</code>）创建定义相应子集的 <code>VirtualServices</code> 和 <code>DestinationRules</code> 是不够的，因为资源（是从配置服务器传播的，即 Kubernetes API 服务器）以最终一致的方式添加到 Pilot 实例的。如果 <code>VirtualService</code> 在定义的子集 <code>DestinationRule</code> 到达之前使用了子集，则 Pilot 生成的 Envoy 配置将引用不存在的上游池。结果就是出现 HTTP 503 错误，直到对于 Pilot 来说所有配置对象都是可用的。</p> <p>为保证服务在配置带有子集的路由时的停机时间为零，请按照下述“先接后断”的流程进行操作：</p> <ul><li>添加新子集时：
<ol><li>更新 <code>DestinationRules</code>，首先添加一个新的子集，然后更新会使用它的所有 <code>VirtualServices</code>，再使用 <code>kubectl</code> 或平台对应的工具应用规则。</li> <li>等待几秒钟，使 <code>DestinationRule</code> 配置传播到 Envoy sidecar。</li> <li>更新 <code>VirtualService</code> 以引用新添加的子集。</li></ol></li> <li>移除子集时：
<ol><li>在从 <code>DestinationRule</code> 中删除子集之前，更新 <code>VirtualServices</code> 以删除对该子集的所有引用。</li> <li>等待几秒钟，使 <code>VirtualService</code> 配置传播到 Envoy sidecar。</li> <li>更新 <code>DestinationRule</code> 以删除未使用的子集。</li></ol></li></ul> <h3 id="避免过于宽泛的-hosts-配置"><a href="#避免过于宽泛的-hosts-配置" class="header-anchor">#</a> 避免过于宽泛的 <code>hosts</code> 配置</h3> <p>如果可能，请避免将 <code>Gateway</code> 资源的 <code>hosts</code> 字段定义地过于宽泛。</p> <p>例如，以下的配置将允许任意的 <code>VirtualService</code> 绑定到 <code>Gateway</code> 之上，很有可能暴露出不应暴露的域：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">servers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
    <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以上设置应该限制于只允许特定的域或命名空间：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">servers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
    <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;foo.example.com&quot;</span> <span class="token comment"># Allow only VirtualServices that are for foo.example.com</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;default/bar.example.com&quot;</span> <span class="token comment"># Allow only VirtualServices in the default namespace that are for bar.example.com</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;route-namespace/*&quot;</span> <span class="token comment"># Allow only VirtualServices in the route-namespace namespace for any host</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr> <h1 id="使用-istioctl-命令行工具"><a href="#使用-istioctl-命令行工具" class="header-anchor">#</a> 使用 Istioctl 命令行工具</h1> <p>您可以使用 <code>proxy-status</code> 或 <code>ps</code> 命令概览您的网格</p> <p><img src="/assets/img/image-20220929174539444.93ba6a60.png" alt="image-20220929174539444"></p> <p>如果列表中缺少代理，这意味着它目前没有连接到 Istiod 实例，因此不会接收任何配置。</p> <ul><li><code>SYNCED</code> 意思是 Envoy 知晓了 Istiod 已经将最新的配置发送给了它。</li> <li><code>NOT SENT</code> 意思是 Istiod 没有发送任何信息给 Envoy。这通常是因为 Istiod 没什么可发送的。</li> <li><code>STALE</code> 意思是 Istiod 已经发送了一个更新到 Envoy，但还没有收到应答。这通常意味着 Envoy 和 Istiod 之间存在网络问题，或者 Istio 自身的 bug。</li></ul> <h2 id="代理配置"><a href="#代理配置" class="header-anchor">#</a> 代理配置</h2> <p><a href="https://istio.io/latest/zh/docs/reference/commands/istioctl" target="_blank" rel="noopener noreferrer"><code>Istioctl</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许你使用 <code>proxy-config</code> 或者 <code>pc</code> 命令检索代理的配置信息。</p> <p>例如检索特定 pod 中 Envoy 实例的集群配置的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ istioctl proxy-config cluster &lt;pod-name&gt; [flags]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检索特定 pod 中 Envoy 实例的 bootstrap 配置的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ istioctl proxy-config bootstrap &lt;pod-name&gt; [flags]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检索特定 pod 中 Envoy 实例的监听器配置的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ istioctl proxy-config listener &lt;pod-name&gt; [flags]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检索特定 pod 中 Envoy 实例的路由配置的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ istioctl proxy-config route &lt;pod-name&gt; [flags]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检索特定 pod 中 Envoy 实例的 endpoint 配置的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ istioctl proxy-config endpoints &lt;pod-name&gt; [flags]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>有关上述命令描述的更多信息，请参考<a href="https://istio.io/latest/zh/docs/ops/diagnostic-tools/proxy-cmd/" target="_blank" rel="noopener noreferrer">调试 Envoy 和 Pilot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="istioctl-x-describe-pod"><a href="#istioctl-x-describe-pod" class="header-anchor">#</a> istioctl x describe pod</h2> <p><img src="/assets/img/image-20220929175719105.97a978a1.png" alt="image-20220929175719105"></p> <h2 id="istioctl-x-describe-svc"><a href="#istioctl-x-describe-svc" class="header-anchor">#</a> istioctl x describe svc</h2> <p>istioctl x describe svc -n mesh app-one</p> <p><img src="/assets/img/image-20220929175658313.73bcb127.png" alt="image-20220929175658313"></p> <h2 id="istioctl-analyze-all-namespaces"><a href="#istioctl-analyze-all-namespaces" class="header-anchor">#</a> istioctl analyze --all-namespaces</h2> <blockquote><p><a href="https://istio.io/latest/zh/docs/ops/diagnostic-tools/istioctl-analyze/" target="_blank" rel="noopener noreferrer">istioctl analyze<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <hr> <h2 id="grafana-dashboard"><a href="#grafana-dashboard" class="header-anchor">#</a> Grafana Dashboard</h2> <ul><li><a href="https://grafana.com/grafana/dashboards/7639" target="_blank" rel="noopener noreferrer">Mesh Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为运行在网格中的所有服务提供概览视图。</li> <li><a href="https://grafana.com/grafana/dashboards/7636" target="_blank" rel="noopener noreferrer">Service Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为服务提供详细的分类指标。</li> <li><a href="https://grafana.com/grafana/dashboards/7630" target="_blank" rel="noopener noreferrer">Workload Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为负载提供详细的分类指标。</li> <li><a href="https://grafana.com/grafana/dashboards/11829" target="_blank" rel="noopener noreferrer">Performance Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 监控网格资源使用情况。</li> <li><a href="https://grafana.com/grafana/dashboards/7645" target="_blank" rel="noopener noreferrer">Control Plane Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 监控控制面的健康状况及性能指标.</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">2023/2/3 05:36:04</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#查看集群中都安装了什么" class="sidebar-link reco-side-查看集群中都安装了什么" data-v-70334359>查看集群中都安装了什么</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#查看-打印-profile" class="sidebar-link reco-side-查看-打印-profile" data-v-70334359>查看/打印 profile</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#查看-istiooperator-差异" class="sidebar-link reco-side-查看-istiooperator-差异" data-v-70334359>查看 IstioOperator 差异</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#检查安装是否成功" class="sidebar-link reco-side-检查安装是否成功" data-v-70334359>检查安装是否成功</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#新增一个-ingress-gateway" class="sidebar-link reco-side-新增一个-ingress-gateway" data-v-70334359>新增一个 ingress gateway</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#自动注入-sidecar" class="sidebar-link reco-side-自动注入-sidecar" data-v-70334359>自动注入 sidecar</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#路由" class="sidebar-link reco-side-路由" data-v-70334359>路由</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#基于身份路由" class="sidebar-link reco-side-基于身份路由" data-v-70334359>基于身份路由</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#注入-http-abort-延迟-故障注入" class="sidebar-link reco-side-注入-http-abort-延迟-故障注入" data-v-70334359>注入 HTTP abort/延迟 故障注入</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#流量管理" class="sidebar-link reco-side-流量管理" data-v-70334359>流量管理</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#请求超时设置" class="sidebar-link reco-side-请求超时设置" data-v-70334359>请求超时设置</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#熔断" class="sidebar-link reco-side-熔断" data-v-70334359>熔断</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#流量镜像" class="sidebar-link reco-side-流量镜像" data-v-70334359>流量镜像</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#地域流量权重分配" class="sidebar-link reco-side-地域流量权重分配" data-v-70334359>地域流量权重分配</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#地域故障转移-todo-开三个node验证" class="sidebar-link reco-side-地域故障转移-todo-开三个node验证" data-v-70334359>地域故障转移(TODO: 开三个node验证)</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#使用-istio-gateway-配置-ingress" class="sidebar-link reco-side-使用-istio-gateway-配置-ingress" data-v-70334359>使用 Istio Gateway 配置 Ingress</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#https-ingress-gateway" class="sidebar-link reco-side-https-ingress-gateway" data-v-70334359>HTTPS ingress gateway</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#为同一个gateway配置多个https证书" class="sidebar-link reco-side-为同一个gateway配置多个https证书" data-v-70334359>为同一个gateway配置多个https证书</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#配置双向-tls-入口网关" class="sidebar-link reco-side-配置双向-tls-入口网关" data-v-70334359>配置双向 TLS 入口网关</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#https-透传" class="sidebar-link reco-side-https-透传" data-v-70334359>HTTPS 透传</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#管理到外部服务的流量" class="sidebar-link reco-side-管理到外部服务的流量" data-v-70334359>管理到外部服务的流量</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#用于-egress-流量的-tls-发起" class="sidebar-link reco-side-用于-egress-流量的-tls-发起" data-v-70334359>用于 egress 流量的 TLS 发起</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#定义-egress-gateway-并引导-http-流量" class="sidebar-link reco-side-定义-egress-gateway-并引导-http-流量" data-v-70334359>定义 Egress gateway 并引导 HTTP 流量</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#egress-后面几章因为测试与实际不符没继续往下看" class="sidebar-link reco-side-egress-后面几章因为测试与实际不符没继续往下看" data-v-70334359>Egress 后面几章因为测试与实际不符没继续往下看</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#traceing" class="sidebar-link reco-side-traceing" data-v-70334359>Traceing</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#自定义跟踪采样" class="sidebar-link reco-side-自定义跟踪采样" data-v-70334359>自定义跟踪采样</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#开始之前" class="sidebar-link reco-side-开始之前" data-v-70334359>开始之前</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#可用的跟踪配置" class="sidebar-link reco-side-可用的跟踪配置" data-v-70334359>可用的跟踪配置</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#安装" class="sidebar-link reco-side-安装" data-v-70334359>安装</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#使用-meshconfig-进行跟踪设置" class="sidebar-link reco-side-使用-meshconfig-进行跟踪设置" data-v-70334359>使用 MeshConfig 进行跟踪设置</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#使用-proxy-istio-io-config-跟踪设置的注释" class="sidebar-link reco-side-使用-proxy-istio-io-config-跟踪设置的注释" data-v-70334359>使用 proxy.istio.io/config 跟踪设置的注释</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#自定义跟踪采样-2" class="sidebar-link reco-side-自定义跟踪采样-2" data-v-70334359>自定义跟踪采样</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#定制跟踪标签" class="sidebar-link reco-side-定制跟踪标签" data-v-70334359>定制跟踪标签</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#kiali" class="sidebar-link reco-side-kiali" data-v-70334359>kiali</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#安全模块没看" class="sidebar-link reco-side-安全模块没看" data-v-70334359>安全模块没看</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#全局以严格模式启用-istio-双向-tls" class="sidebar-link reco-side-全局以严格模式启用-istio-双向-tls" data-v-70334359>全局以严格模式启用 Istio 双向 TLS</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#为每个命名空间或者工作负载启用双向-tls" class="sidebar-link reco-side-为每个命名空间或者工作负载启用双向-tls" data-v-70334359>为每个命名空间或者工作负载启用双向 TLS</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#为每个工作负载启用双向-tls" class="sidebar-link reco-side-为每个工作负载启用双向-tls" data-v-70334359>为每个工作负载启用双向 TLS</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#策略优先级" class="sidebar-link reco-side-策略优先级" data-v-70334359>策略优先级</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#应用程序要求" class="sidebar-link reco-side-应用程序要求" data-v-70334359>应用程序要求</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#x-forwarded-for" class="sidebar-link reco-side-x-forwarded-for" data-v-70334359>X-Forwarded-For</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#最佳实践" class="sidebar-link reco-side-最佳实践" data-v-70334359>最佳实践</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#避免重新配置服务路由时出现-503-错误" class="sidebar-link reco-side-避免重新配置服务路由时出现-503-错误" data-v-70334359>避免重新配置服务路由时出现 503 错误</a></li><li class="level-3" data-v-70334359><a href="/blogs/2022/istio-cheat.html#避免过于宽泛的-hosts-配置" class="sidebar-link reco-side-避免过于宽泛的-hosts-配置" data-v-70334359>避免过于宽泛的 hosts 配置</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#代理配置" class="sidebar-link reco-side-代理配置" data-v-70334359>代理配置</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#istioctl-x-describe-pod" class="sidebar-link reco-side-istioctl-x-describe-pod" data-v-70334359>istioctl x describe pod</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#istioctl-x-describe-svc" class="sidebar-link reco-side-istioctl-x-describe-svc" data-v-70334359>istioctl x describe svc</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#istioctl-analyze-all-namespaces" class="sidebar-link reco-side-istioctl-analyze-all-namespaces" data-v-70334359>istioctl analyze --all-namespaces</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/istio-cheat.html#grafana-dashboard" class="sidebar-link reco-side-grafana-dashboard" data-v-70334359>Grafana Dashboard</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.4c3b9d5c.js" defer></script><script src="/assets/js/5.42a81560.js" defer></script><script src="/assets/js/1.77f0e2a2.js" defer></script><script src="/assets/js/16.10f43882.js" defer></script>
  </body>
</html>
