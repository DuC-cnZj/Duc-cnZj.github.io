<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>k8s 每日一问 - nginx ingress local traffic = Local 问题总结以及 externalTrafficPolicy=Local 原理 | DUC&#39;S Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="何时才能暴富">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a5fc1f3a.css" as="style"><link rel="preload" href="/assets/js/app.9ade373e.js" as="script"><link rel="preload" href="/assets/js/5.42a81560.js" as="script"><link rel="preload" href="/assets/js/1.77f0e2a2.js" as="script"><link rel="preload" href="/assets/js/165.4be0f4af.js" as="script"><link rel="prefetch" href="/assets/js/10.fe983c47.js"><link rel="prefetch" href="/assets/js/100.93329dd6.js"><link rel="prefetch" href="/assets/js/101.843da4d0.js"><link rel="prefetch" href="/assets/js/102.fa29c7b3.js"><link rel="prefetch" href="/assets/js/103.81e7b51f.js"><link rel="prefetch" href="/assets/js/104.7e81a5ae.js"><link rel="prefetch" href="/assets/js/105.a2381821.js"><link rel="prefetch" href="/assets/js/106.c3190b65.js"><link rel="prefetch" href="/assets/js/107.448a2664.js"><link rel="prefetch" href="/assets/js/108.33d58b32.js"><link rel="prefetch" href="/assets/js/109.877eeccc.js"><link rel="prefetch" href="/assets/js/11.fad29b69.js"><link rel="prefetch" href="/assets/js/110.1fdadea1.js"><link rel="prefetch" href="/assets/js/111.5aafdc13.js"><link rel="prefetch" href="/assets/js/112.b72c8913.js"><link rel="prefetch" href="/assets/js/113.c99838af.js"><link rel="prefetch" href="/assets/js/114.97981133.js"><link rel="prefetch" href="/assets/js/115.b2689a56.js"><link rel="prefetch" href="/assets/js/116.3f26c7f1.js"><link rel="prefetch" href="/assets/js/117.08d86b3d.js"><link rel="prefetch" href="/assets/js/118.a10c0b3d.js"><link rel="prefetch" href="/assets/js/119.da1d5eb9.js"><link rel="prefetch" href="/assets/js/12.2f295253.js"><link rel="prefetch" href="/assets/js/120.a01e39f0.js"><link rel="prefetch" href="/assets/js/121.d5fdb799.js"><link rel="prefetch" href="/assets/js/122.38176ce1.js"><link rel="prefetch" href="/assets/js/123.cb8659ee.js"><link rel="prefetch" href="/assets/js/124.ffca240a.js"><link rel="prefetch" href="/assets/js/125.45025220.js"><link rel="prefetch" href="/assets/js/126.e70619c9.js"><link rel="prefetch" href="/assets/js/127.80436e51.js"><link rel="prefetch" href="/assets/js/128.5ee2d458.js"><link rel="prefetch" href="/assets/js/129.e82d4765.js"><link rel="prefetch" href="/assets/js/13.a5d69620.js"><link rel="prefetch" href="/assets/js/130.ae6a65c5.js"><link rel="prefetch" href="/assets/js/131.fb00adce.js"><link rel="prefetch" href="/assets/js/132.11d0bf15.js"><link rel="prefetch" href="/assets/js/133.91bd8394.js"><link rel="prefetch" href="/assets/js/134.b69e6ac7.js"><link rel="prefetch" href="/assets/js/135.fe54e11b.js"><link rel="prefetch" href="/assets/js/136.af0d5941.js"><link rel="prefetch" href="/assets/js/137.1e170174.js"><link rel="prefetch" href="/assets/js/138.e767d978.js"><link rel="prefetch" href="/assets/js/139.287753ae.js"><link rel="prefetch" href="/assets/js/14.62511239.js"><link rel="prefetch" href="/assets/js/140.f9838aa8.js"><link rel="prefetch" href="/assets/js/141.43b7ab5b.js"><link rel="prefetch" href="/assets/js/142.76b755f4.js"><link rel="prefetch" href="/assets/js/143.6960a5a9.js"><link rel="prefetch" href="/assets/js/144.90ff747e.js"><link rel="prefetch" href="/assets/js/145.80f708ab.js"><link rel="prefetch" href="/assets/js/146.ce06e25e.js"><link rel="prefetch" href="/assets/js/147.65e76c00.js"><link rel="prefetch" href="/assets/js/148.f58e72d8.js"><link rel="prefetch" href="/assets/js/149.e559a17a.js"><link rel="prefetch" href="/assets/js/15.ea731939.js"><link rel="prefetch" href="/assets/js/150.6332c9fa.js"><link rel="prefetch" href="/assets/js/151.f5767e2a.js"><link rel="prefetch" href="/assets/js/152.6f31f692.js"><link rel="prefetch" href="/assets/js/153.b6163e53.js"><link rel="prefetch" href="/assets/js/154.6244a7a1.js"><link rel="prefetch" href="/assets/js/155.d4a5bb53.js"><link rel="prefetch" href="/assets/js/156.27ea7524.js"><link rel="prefetch" href="/assets/js/157.ee611a1c.js"><link rel="prefetch" href="/assets/js/158.a74fc4fc.js"><link rel="prefetch" href="/assets/js/159.3b00fc6a.js"><link rel="prefetch" href="/assets/js/16.ea9a6bff.js"><link rel="prefetch" href="/assets/js/160.a01545c9.js"><link rel="prefetch" href="/assets/js/161.2a8494d2.js"><link rel="prefetch" href="/assets/js/162.4f3575a2.js"><link rel="prefetch" href="/assets/js/163.2ad5597e.js"><link rel="prefetch" href="/assets/js/164.7d14299f.js"><link rel="prefetch" href="/assets/js/166.35f1aac0.js"><link rel="prefetch" href="/assets/js/167.778f9d92.js"><link rel="prefetch" href="/assets/js/168.fb82cd8c.js"><link rel="prefetch" href="/assets/js/169.db48ddd3.js"><link rel="prefetch" href="/assets/js/17.1632bfad.js"><link rel="prefetch" href="/assets/js/170.2f031b47.js"><link rel="prefetch" href="/assets/js/171.654ad2e2.js"><link rel="prefetch" href="/assets/js/172.03aa3c26.js"><link rel="prefetch" href="/assets/js/173.e9e1ddac.js"><link rel="prefetch" href="/assets/js/174.40e1900c.js"><link rel="prefetch" href="/assets/js/175.fe8d7ad9.js"><link rel="prefetch" href="/assets/js/176.e0ab6ca6.js"><link rel="prefetch" href="/assets/js/177.f3b2e140.js"><link rel="prefetch" href="/assets/js/178.ce15e37c.js"><link rel="prefetch" href="/assets/js/179.ecb57e40.js"><link rel="prefetch" href="/assets/js/18.7e38f777.js"><link rel="prefetch" href="/assets/js/180.5ea96ddd.js"><link rel="prefetch" href="/assets/js/181.8dfeb7ef.js"><link rel="prefetch" href="/assets/js/182.6b69aa02.js"><link rel="prefetch" href="/assets/js/19.d65709b0.js"><link rel="prefetch" href="/assets/js/20.ac27961c.js"><link rel="prefetch" href="/assets/js/21.dad8650a.js"><link rel="prefetch" href="/assets/js/22.e4f93a86.js"><link rel="prefetch" href="/assets/js/23.70b0da30.js"><link rel="prefetch" href="/assets/js/24.c8e4f393.js"><link rel="prefetch" href="/assets/js/25.21ed46fe.js"><link rel="prefetch" href="/assets/js/26.e1ca4e6f.js"><link rel="prefetch" href="/assets/js/27.963758aa.js"><link rel="prefetch" href="/assets/js/28.8ec2c834.js"><link rel="prefetch" href="/assets/js/29.8af24673.js"><link rel="prefetch" href="/assets/js/3.ab35018f.js"><link rel="prefetch" href="/assets/js/30.da4b7944.js"><link rel="prefetch" href="/assets/js/31.df19a6fd.js"><link rel="prefetch" href="/assets/js/32.45ea6fc8.js"><link rel="prefetch" href="/assets/js/33.9a7b2150.js"><link rel="prefetch" href="/assets/js/34.77a51303.js"><link rel="prefetch" href="/assets/js/35.c98a568e.js"><link rel="prefetch" href="/assets/js/36.3e2ac2a4.js"><link rel="prefetch" href="/assets/js/37.32a271dd.js"><link rel="prefetch" href="/assets/js/38.30ffc24b.js"><link rel="prefetch" href="/assets/js/39.3d465d47.js"><link rel="prefetch" href="/assets/js/4.3063c18c.js"><link rel="prefetch" href="/assets/js/40.221732d0.js"><link rel="prefetch" href="/assets/js/41.571032ac.js"><link rel="prefetch" href="/assets/js/42.1da2e35f.js"><link rel="prefetch" href="/assets/js/43.e8c113fb.js"><link rel="prefetch" href="/assets/js/44.9acf20eb.js"><link rel="prefetch" href="/assets/js/45.b849d0fb.js"><link rel="prefetch" href="/assets/js/46.e9fc9612.js"><link rel="prefetch" href="/assets/js/47.51f1ae83.js"><link rel="prefetch" href="/assets/js/48.929cd91b.js"><link rel="prefetch" href="/assets/js/49.99e23be5.js"><link rel="prefetch" href="/assets/js/50.fe10f20e.js"><link rel="prefetch" href="/assets/js/51.beec6026.js"><link rel="prefetch" href="/assets/js/52.02ed9936.js"><link rel="prefetch" href="/assets/js/53.b244c4a3.js"><link rel="prefetch" href="/assets/js/54.10368b35.js"><link rel="prefetch" href="/assets/js/55.c2b8c795.js"><link rel="prefetch" href="/assets/js/56.2fb224c7.js"><link rel="prefetch" href="/assets/js/57.8481e893.js"><link rel="prefetch" href="/assets/js/58.eaf225a8.js"><link rel="prefetch" href="/assets/js/59.f96d625d.js"><link rel="prefetch" href="/assets/js/6.6b163ae0.js"><link rel="prefetch" href="/assets/js/60.d4a1e374.js"><link rel="prefetch" href="/assets/js/61.b2062db2.js"><link rel="prefetch" href="/assets/js/62.0fdbbe3e.js"><link rel="prefetch" href="/assets/js/63.5bba3aaf.js"><link rel="prefetch" href="/assets/js/64.ca15ea67.js"><link rel="prefetch" href="/assets/js/65.82a7be95.js"><link rel="prefetch" href="/assets/js/66.62eb0e42.js"><link rel="prefetch" href="/assets/js/67.db6b1f81.js"><link rel="prefetch" href="/assets/js/68.ece940ca.js"><link rel="prefetch" href="/assets/js/69.c6a12f4a.js"><link rel="prefetch" href="/assets/js/7.28d05c1f.js"><link rel="prefetch" href="/assets/js/70.ef3073fe.js"><link rel="prefetch" href="/assets/js/71.defd9ebf.js"><link rel="prefetch" href="/assets/js/72.b2277e4e.js"><link rel="prefetch" href="/assets/js/73.630609b1.js"><link rel="prefetch" href="/assets/js/74.3d1507d0.js"><link rel="prefetch" href="/assets/js/75.a35d33df.js"><link rel="prefetch" href="/assets/js/76.a8db2b7f.js"><link rel="prefetch" href="/assets/js/77.79741667.js"><link rel="prefetch" href="/assets/js/78.cfd05069.js"><link rel="prefetch" href="/assets/js/79.807f6fcf.js"><link rel="prefetch" href="/assets/js/8.59e3eaf0.js"><link rel="prefetch" href="/assets/js/80.83b50d82.js"><link rel="prefetch" href="/assets/js/81.ebf54785.js"><link rel="prefetch" href="/assets/js/82.bd035c55.js"><link rel="prefetch" href="/assets/js/83.fdfe6663.js"><link rel="prefetch" href="/assets/js/84.ad24491b.js"><link rel="prefetch" href="/assets/js/85.416d4dc2.js"><link rel="prefetch" href="/assets/js/86.4ec414ec.js"><link rel="prefetch" href="/assets/js/87.c35a3a22.js"><link rel="prefetch" href="/assets/js/88.bd43f2bf.js"><link rel="prefetch" href="/assets/js/89.8077a111.js"><link rel="prefetch" href="/assets/js/9.cf139049.js"><link rel="prefetch" href="/assets/js/90.21366f63.js"><link rel="prefetch" href="/assets/js/91.23e54bf0.js"><link rel="prefetch" href="/assets/js/92.9d582183.js"><link rel="prefetch" href="/assets/js/93.6cc7928f.js"><link rel="prefetch" href="/assets/js/94.bc621ef1.js"><link rel="prefetch" href="/assets/js/95.2c7524ca.js"><link rel="prefetch" href="/assets/js/96.0f8f598a.js"><link rel="prefetch" href="/assets/js/97.8fde4240.js"><link rel="prefetch" href="/assets/js/98.176f9256.js"><link rel="prefetch" href="/assets/js/99.95bf4709.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a5fc1f3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>duc</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>duc's blog</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>duc</span>
            
          <span data-v-4e82dffc>2018 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="DUC'S Blog" class="logo"> <span class="site-name">DUC'S Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/书籍/" class="nav-link"><i class="undefined"></i>
  书籍
</a></li><li class="dropdown-item"><!----> <a href="/categories/计划/" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/未来/" class="nav-link"><i class="undefined"></i>
  未来
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duc-cnZj" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    duc
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>172</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>150</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/书籍/" class="nav-link"><i class="undefined"></i>
  书籍
</a></li><li class="dropdown-item"><!----> <a href="/categories/计划/" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/未来/" class="nav-link"><i class="undefined"></i>
  未来
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duc-cnZj" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>k8s 每日一问 - nginx ingress local traffic = Local 问题总结以及 externalTrafficPolicy=Local 原理</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>duc</span>
            
          <span data-v-4e82dffc>2018 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">k8s 每日一问 - nginx ingress local traffic = Local 问题总结以及 externalTrafficPolicy=Local 原理</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>duc</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2022/12/9</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/blogs/2022/daily_topic19.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>每日一问</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="nginx-ingress-local-traffic-local-问题总结"><a href="#nginx-ingress-local-traffic-local-问题总结" class="header-anchor">#</a> nginx ingress local traffic = Local 问题总结</h2> <ol><li>从外部通过域名访问app服务: 这样是ok的,因为外部进来总是通过 lb 转发到服务， lb 的 backend 总是对应到有 nginx pod 的节点</li> <li>从内部pod通过<strong>域名</strong>访问app服务
<ul><li>pod 和 nginx 在同一个节点上: <font color="green">ok</font></li> <li>pod 和 nginx 不在同一个节点上: <font color="red">失败</font>, 因为pod先去解析域名，得到nginx外部ip地址，又因为外部流量策略是Local，使得 iptables 规则访问的域名ip只会转发到和pod所在节点上的nginx 地址， 所以此时访问 nginx 必须是 pod 所在 node 上的 nginx，如果没有就会丢弃流量
1. podA 域名访问 app
2.  得到域名的外部 ip，比如 1.2.3.4
3. 因为 nginx svc 流量策略是 Local, 所以 1.2.3.4 在podA所在节点node1的路由规则，只会把流量转发到节点node1上的 nginx pod, 因为node1没有nginx pod，所以该部分流量就会被丢弃</li></ul></li></ol> <h2 id="externaltrafficpolicy-local-原理"><a href="#externaltrafficpolicy-local-原理" class="header-anchor">#</a> externalTrafficPolicy=Local 原理</h2> <blockquote><p><a href="https://blog.csdn.net/qq_20817327/article/details/113770498" target="_blank" rel="noopener noreferrer">-m addrtype --src-type LOCAL 解释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>详见 kube-proxy 源码 iptabels/proxier_test.go 代码</p> <p>当为 Local 时，iptables nat 只会使用 KUBE-SVL-XXXX 的规则，这个规则只包含了 当前节点上的 pod ip<code>-A KUBE-SVL-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.2.1:80&quot; -j KUBE-SEP-ZX7GRIZKSNUQ3LAJ</code></p> <p>如果当前节点上没有 svc 对应的 pod 则会显示<code>-A KUBE-SVL-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 has no local endpoints&quot; -j KUBE-MARK-DROP</code></p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestOnlyLocalExternalIPs</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ipt <span class="token operator">:=</span> iptablestest<span class="token punctuation">.</span><span class="token function">NewFake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fp <span class="token operator">:=</span> <span class="token function">NewFakeProxier</span><span class="token punctuation">(</span>ipt<span class="token punctuation">)</span>
	svcIP <span class="token operator">:=</span> <span class="token string">&quot;172.30.0.41&quot;</span>
	svcPort <span class="token operator">:=</span> <span class="token number">80</span>
	svcExternalIPs <span class="token operator">:=</span> <span class="token string">&quot;192.168.99.11&quot;</span>
	svcPortName <span class="token operator">:=</span> proxy<span class="token punctuation">.</span>ServicePortName<span class="token punctuation">{</span>
		NamespacedName<span class="token punctuation">:</span> <span class="token function">makeNSN</span><span class="token punctuation">(</span><span class="token string">&quot;ns1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;svc1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>           <span class="token string">&quot;p80&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token function">makeServiceMap</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span>
		<span class="token function">makeTestService</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> svcPortName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>svc <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Type <span class="token operator">=</span> <span class="token string">&quot;NodePort&quot;</span>
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ExternalTrafficPolicy <span class="token operator">=</span> v1<span class="token punctuation">.</span>ServiceExternalTrafficPolicyTypeLocal
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ClusterIP <span class="token operator">=</span> svcIP
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ExternalIPs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>svcExternalIPs<span class="token punctuation">}</span>
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>ServicePort<span class="token punctuation">{</span><span class="token punctuation">{</span>
				Name<span class="token punctuation">:</span>       svcPortName<span class="token punctuation">.</span>Port<span class="token punctuation">,</span>
				Port<span class="token punctuation">:</span>       <span class="token function">int32</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
				Protocol<span class="token punctuation">:</span>   v1<span class="token punctuation">.</span>ProtocolTCP<span class="token punctuation">,</span>
				TargetPort<span class="token punctuation">:</span> intstr<span class="token punctuation">.</span><span class="token function">FromInt</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	epIP1 <span class="token operator">:=</span> <span class="token string">&quot;10.180.0.1&quot;</span>
	epIP2 <span class="token operator">:=</span> <span class="token string">&quot;10.180.2.1&quot;</span>
	tcpProtocol <span class="token operator">:=</span> v1<span class="token punctuation">.</span>ProtocolTCP
	<span class="token function">populateEndpointSlices</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span>
		<span class="token function">makeTestEndpointSlice</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> svcPortName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>eps <span class="token operator">*</span>discovery<span class="token punctuation">.</span>EndpointSlice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			eps<span class="token punctuation">.</span>AddressType <span class="token operator">=</span> discovery<span class="token punctuation">.</span>AddressTypeIPv4
			eps<span class="token punctuation">.</span>Endpoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>discovery<span class="token punctuation">.</span>Endpoint<span class="token punctuation">{</span>
				<span class="token punctuation">{</span>
					Addresses<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>epIP1<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{</span>
					Addresses<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>epIP2<span class="token punctuation">}</span><span class="token punctuation">,</span>
					NodeName<span class="token punctuation">:</span>  utilpointer<span class="token punctuation">.</span><span class="token function">StringPtr</span><span class="token punctuation">(</span>testHostname<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
			eps<span class="token punctuation">.</span>Ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>discovery<span class="token punctuation">.</span>EndpointPort<span class="token punctuation">{</span><span class="token punctuation">{</span>
				Name<span class="token punctuation">:</span>     utilpointer<span class="token punctuation">.</span><span class="token function">StringPtr</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
				Port<span class="token punctuation">:</span>     utilpointer<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				Protocol<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tcpProtocol<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	fp<span class="token punctuation">.</span><span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	expected <span class="token operator">:=</span> dedent<span class="token punctuation">.</span><span class="token function">Dedent</span><span class="token punctuation">(</span><span class="token string">`
		*filter
		:KUBE-EXTERNAL-SERVICES - [0:0]
		:KUBE-FORWARD - [0:0]
		:KUBE-NODEPORTS - [0:0]
		:KUBE-SERVICES - [0:0]
		-A KUBE-FORWARD -m conntrack --ctstate INVALID -j DROP
		-A KUBE-FORWARD -m comment --comment &quot;kubernetes forwarding rules&quot; -m mark --mark 0x4000/0x4000 -j ACCEPT
		-A KUBE-FORWARD -m comment --comment &quot;kubernetes forwarding conntrack rule&quot; -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
		COMMIT
		*nat
		:KUBE-EXT-XPGD46QRK7WJZT7O - [0:0]
		:KUBE-MARK-MASQ - [0:0]
		:KUBE-NODEPORTS - [0:0]
		:KUBE-POSTROUTING - [0:0]
		:KUBE-SEP-SXIVWICOYRO3J4NJ - [0:0]
		:KUBE-SEP-ZX7GRIZKSNUQ3LAJ - [0:0]
		:KUBE-SERVICES - [0:0]
		:KUBE-SVC-XPGD46QRK7WJZT7O - [0:0]
		:KUBE-SVL-XPGD46QRK7WJZT7O - [0:0]
		-A KUBE-SERVICES -m comment --comment &quot;ns1/svc1:p80 cluster IP&quot; -m tcp -p tcp -d 172.30.0.41 --dport 80 -j KUBE-SVC-XPGD46QRK7WJZT7O
		-A KUBE-SERVICES -m comment --comment &quot;ns1/svc1:p80 external IP&quot; -m tcp -p tcp -d 192.168.99.11 --dport 80 -j KUBE-EXT-XPGD46QRK7WJZT7O
		-A KUBE-SERVICES -m comment --comment &quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
		-A KUBE-EXT-XPGD46QRK7WJZT7O -m comment --comment &quot;pod traffic for ns1/svc1:p80 external destinations&quot; -s 10.0.0.0/8 -j KUBE-SVC-XPGD46QRK7WJZT7O
		-A KUBE-EXT-XPGD46QRK7WJZT7O -m comment --comment &quot;masquerade LOCAL traffic for ns1/svc1:p80 external destinations&quot; -m addrtype --src-type LOCAL -j KUBE-MARK-MASQ
		-A KUBE-EXT-XPGD46QRK7WJZT7O -m comment --comment &quot;route LOCAL traffic for ns1/svc1:p80 external destinations&quot; -m addrtype --src-type LOCAL -j KUBE-SVC-XPGD46QRK7WJZT7O
		-A KUBE-EXT-XPGD46QRK7WJZT7O -j KUBE-SVL-XPGD46QRK7WJZT7O
		-A KUBE-MARK-MASQ -j MARK --or-mark 0x4000
		-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN
		-A KUBE-POSTROUTING -j MARK --xor-mark 0x4000
		-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE
		-A KUBE-SEP-SXIVWICOYRO3J4NJ -m comment --comment ns1/svc1:p80 -s 10.180.0.1 -j KUBE-MARK-MASQ
		-A KUBE-SEP-SXIVWICOYRO3J4NJ -m comment --comment ns1/svc1:p80 -m tcp -p tcp -j DNAT --to-destination 10.180.0.1:80
		-A KUBE-SEP-ZX7GRIZKSNUQ3LAJ -m comment --comment ns1/svc1:p80 -s 10.180.2.1 -j KUBE-MARK-MASQ
		-A KUBE-SEP-ZX7GRIZKSNUQ3LAJ -m comment --comment ns1/svc1:p80 -m tcp -p tcp -j DNAT --to-destination 10.180.2.1:80
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 cluster IP&quot; -m tcp -p tcp -d 172.30.0.41 --dport 80 ! -s 10.0.0.0/8 -j KUBE-MARK-MASQ
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.0.1:80&quot; -m statistic --mode random --probability 0.5000000000 -j KUBE-SEP-SXIVWICOYRO3J4NJ
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.2.1:80&quot; -j KUBE-SEP-ZX7GRIZKSNUQ3LAJ
		-A KUBE-SVL-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.2.1:80&quot; -j KUBE-SEP-ZX7GRIZKSNUQ3LAJ
		COMMIT
		`</span><span class="token punctuation">)</span>
	<span class="token function">assertIPTablesRulesEqual</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expected<span class="token punctuation">,</span> fp<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token function">runPacketFlowTests</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testNodeIP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>packetFlowTest<span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>     <span class="token string">&quot;cluster IP hits both endpoints&quot;</span><span class="token punctuation">,</span>
			sourceIP<span class="token punctuation">:</span> <span class="token string">&quot;10.0.0.2&quot;</span><span class="token punctuation">,</span>
			destIP<span class="token punctuation">:</span>   svcIP<span class="token punctuation">,</span>
			destPort<span class="token punctuation">:</span> svcPort<span class="token punctuation">,</span>
			output<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d, %s:%d&quot;</span><span class="token punctuation">,</span> epIP1<span class="token punctuation">,</span> svcPort<span class="token punctuation">,</span> epIP2<span class="token punctuation">,</span> svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			masq<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>     <span class="token string">&quot;external IP hits only local endpoint, unmasqueraded&quot;</span><span class="token punctuation">,</span>
			sourceIP<span class="token punctuation">:</span> testExternalClient<span class="token punctuation">,</span>
			destIP<span class="token punctuation">:</span>   svcExternalIPs<span class="token punctuation">,</span>
			destPort<span class="token punctuation">:</span> svcPort<span class="token punctuation">,</span>
			output<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d&quot;</span><span class="token punctuation">,</span> epIP2<span class="token punctuation">,</span> svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			masq<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// TestNonLocalExternalIPs tests if we add the masquerade rule into svcChain in order to</span>
<span class="token comment">// SNAT packets to external IPs if externalTrafficPolicy is cluster and the traffic is NOT Local.</span>
<span class="token keyword">func</span> <span class="token function">TestNonLocalExternalIPs</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ipt <span class="token operator">:=</span> iptablestest<span class="token punctuation">.</span><span class="token function">NewFake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fp <span class="token operator">:=</span> <span class="token function">NewFakeProxier</span><span class="token punctuation">(</span>ipt<span class="token punctuation">)</span>
	svcIP <span class="token operator">:=</span> <span class="token string">&quot;172.30.0.41&quot;</span>
	svcPort <span class="token operator">:=</span> <span class="token number">80</span>
	svcExternalIPs <span class="token operator">:=</span> <span class="token string">&quot;192.168.99.11&quot;</span>
	svcPortName <span class="token operator">:=</span> proxy<span class="token punctuation">.</span>ServicePortName<span class="token punctuation">{</span>
		NamespacedName<span class="token punctuation">:</span> <span class="token function">makeNSN</span><span class="token punctuation">(</span><span class="token string">&quot;ns1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;svc1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>           <span class="token string">&quot;p80&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token function">makeServiceMap</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span>
		<span class="token function">makeTestService</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> svcPortName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>svc <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ClusterIP <span class="token operator">=</span> svcIP
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ExternalIPs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>svcExternalIPs<span class="token punctuation">}</span>
			svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>ServicePort<span class="token punctuation">{</span><span class="token punctuation">{</span>
				Name<span class="token punctuation">:</span>       svcPortName<span class="token punctuation">.</span>Port<span class="token punctuation">,</span>
				Port<span class="token punctuation">:</span>       <span class="token function">int32</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
				Protocol<span class="token punctuation">:</span>   v1<span class="token punctuation">.</span>ProtocolTCP<span class="token punctuation">,</span>
				TargetPort<span class="token punctuation">:</span> intstr<span class="token punctuation">.</span><span class="token function">FromInt</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	epIP1 <span class="token operator">:=</span> <span class="token string">&quot;10.180.0.1&quot;</span>
	epIP2 <span class="token operator">:=</span> <span class="token string">&quot;10.180.2.1&quot;</span>
	tcpProtocol <span class="token operator">:=</span> v1<span class="token punctuation">.</span>ProtocolTCP
	<span class="token function">populateEndpointSlices</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span>
		<span class="token function">makeTestEndpointSlice</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> svcPortName<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>eps <span class="token operator">*</span>discovery<span class="token punctuation">.</span>EndpointSlice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			eps<span class="token punctuation">.</span>AddressType <span class="token operator">=</span> discovery<span class="token punctuation">.</span>AddressTypeIPv4
			eps<span class="token punctuation">.</span>Endpoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>discovery<span class="token punctuation">.</span>Endpoint<span class="token punctuation">{</span><span class="token punctuation">{</span>
				Addresses<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>epIP1<span class="token punctuation">}</span><span class="token punctuation">,</span>
				NodeName<span class="token punctuation">:</span>  <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				Addresses<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>epIP2<span class="token punctuation">}</span><span class="token punctuation">,</span>
				NodeName<span class="token punctuation">:</span>  utilpointer<span class="token punctuation">.</span><span class="token function">StringPtr</span><span class="token punctuation">(</span>testHostname<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span>
			eps<span class="token punctuation">.</span>Ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>discovery<span class="token punctuation">.</span>EndpointPort<span class="token punctuation">{</span><span class="token punctuation">{</span>
				Name<span class="token punctuation">:</span>     utilpointer<span class="token punctuation">.</span><span class="token function">StringPtr</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
				Port<span class="token punctuation">:</span>     utilpointer<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>svcPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				Protocol<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tcpProtocol<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	fp<span class="token punctuation">.</span><span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	expected <span class="token operator">:=</span> dedent<span class="token punctuation">.</span><span class="token function">Dedent</span><span class="token punctuation">(</span><span class="token string">`
		*filter
		:KUBE-EXTERNAL-SERVICES - [0:0]
		:KUBE-FORWARD - [0:0]
		:KUBE-NODEPORTS - [0:0]
		:KUBE-SERVICES - [0:0]
		-A KUBE-FORWARD -m conntrack --ctstate INVALID -j DROP
		-A KUBE-FORWARD -m comment --comment &quot;kubernetes forwarding rules&quot; -m mark --mark 0x4000/0x4000 -j ACCEPT
		-A KUBE-FORWARD -m comment --comment &quot;kubernetes forwarding conntrack rule&quot; -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
		COMMIT
		*nat
		:KUBE-EXT-XPGD46QRK7WJZT7O - [0:0]
		:KUBE-MARK-MASQ - [0:0]
		:KUBE-NODEPORTS - [0:0]
		:KUBE-POSTROUTING - [0:0]
		:KUBE-SEP-SXIVWICOYRO3J4NJ - [0:0]
		:KUBE-SEP-ZX7GRIZKSNUQ3LAJ - [0:0]
		:KUBE-SERVICES - [0:0]
		:KUBE-SVC-XPGD46QRK7WJZT7O - [0:0]
		-A KUBE-SERVICES -m comment --comment &quot;ns1/svc1:p80 cluster IP&quot; -m tcp -p tcp -d 172.30.0.41 --dport 80 -j KUBE-SVC-XPGD46QRK7WJZT7O
		-A KUBE-SERVICES -m comment --comment &quot;ns1/svc1:p80 external IP&quot; -m tcp -p tcp -d 192.168.99.11 --dport 80 -j KUBE-EXT-XPGD46QRK7WJZT7O
		-A KUBE-SERVICES -m comment --comment &quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
		-A KUBE-EXT-XPGD46QRK7WJZT7O -m comment --comment &quot;masquerade traffic for ns1/svc1:p80 external destinations&quot; -j KUBE-MARK-MASQ
		-A KUBE-EXT-XPGD46QRK7WJZT7O -j KUBE-SVC-XPGD46QRK7WJZT7O
		-A KUBE-MARK-MASQ -j MARK --or-mark 0x4000
		-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN
		-A KUBE-POSTROUTING -j MARK --xor-mark 0x4000
		-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE
		-A KUBE-SEP-SXIVWICOYRO3J4NJ -m comment --comment ns1/svc1:p80 -s 10.180.0.1 -j KUBE-MARK-MASQ
		-A KUBE-SEP-SXIVWICOYRO3J4NJ -m comment --comment ns1/svc1:p80 -m tcp -p tcp -j DNAT --to-destination 10.180.0.1:80
		-A KUBE-SEP-ZX7GRIZKSNUQ3LAJ -m comment --comment ns1/svc1:p80 -s 10.180.2.1 -j KUBE-MARK-MASQ
		-A KUBE-SEP-ZX7GRIZKSNUQ3LAJ -m comment --comment ns1/svc1:p80 -m tcp -p tcp -j DNAT --to-destination 10.180.2.1:80
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 cluster IP&quot; -m tcp -p tcp -d 172.30.0.41 --dport 80 ! -s 10.0.0.0/8 -j KUBE-MARK-MASQ
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.0.1:80&quot; -m statistic --mode random --probability 0.5000000000 -j KUBE-SEP-SXIVWICOYRO3J4NJ
		-A KUBE-SVC-XPGD46QRK7WJZT7O -m comment --comment &quot;ns1/svc1:p80 -&gt; 10.180.2.1:80&quot; -j KUBE-SEP-ZX7GRIZKSNUQ3LAJ
		COMMIT
		`</span><span class="token punctuation">)</span>
	<span class="token function">assertIPTablesRulesEqual</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expected<span class="token punctuation">,</span> fp<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token function">runPacketFlowTests</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testNodeIP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>packetFlowTest<span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>     <span class="token string">&quot;pod to cluster IP&quot;</span><span class="token punctuation">,</span>
			sourceIP<span class="token punctuation">:</span> <span class="token string">&quot;10.0.0.2&quot;</span><span class="token punctuation">,</span>
			destIP<span class="token punctuation">:</span>   svcIP<span class="token punctuation">,</span>
			destPort<span class="token punctuation">:</span> svcPort<span class="token punctuation">,</span>
			output<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d, %s:%d&quot;</span><span class="token punctuation">,</span> epIP1<span class="token punctuation">,</span> svcPort<span class="token punctuation">,</span> epIP2<span class="token punctuation">,</span> svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			masq<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>     <span class="token string">&quot;external to external IP&quot;</span><span class="token punctuation">,</span>
			sourceIP<span class="token punctuation">:</span> testExternalClient<span class="token punctuation">,</span>
			destIP<span class="token punctuation">:</span>   svcExternalIPs<span class="token punctuation">,</span>
			destPort<span class="token punctuation">:</span> svcPort<span class="token punctuation">,</span>
			output<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d, %s:%d&quot;</span><span class="token punctuation">,</span> epIP1<span class="token punctuation">,</span> svcPort<span class="token punctuation">,</span> epIP2<span class="token punctuation">,</span> svcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			masq<span class="token punctuation">:</span>     <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">2023/2/14 02:24:43</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blogs/2022/daily_topic19.html#nginx-ingress-local-traffic-local-问题总结" class="sidebar-link reco-side-nginx-ingress-local-traffic-local-问题总结" data-v-70334359>nginx ingress local traffic = Local 问题总结</a></li><li class="level-2" data-v-70334359><a href="/blogs/2022/daily_topic19.html#externaltrafficpolicy-local-原理" class="sidebar-link reco-side-externaltrafficpolicy-local-原理" data-v-70334359>externalTrafficPolicy=Local 原理</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.9ade373e.js" defer></script><script src="/assets/js/5.42a81560.js" defer></script><script src="/assets/js/1.77f0e2a2.js" defer></script><script src="/assets/js/165.4be0f4af.js" defer></script>
  </body>
</html>
